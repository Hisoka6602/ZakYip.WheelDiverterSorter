# ä¼ æ„Ÿå™¨ç”µå¹³è¯»å–ä»£ç æ€§èƒ½åˆ†ææŠ¥å‘Š

## æ¦‚è¿°

æœ¬æ–‡æ¡£åˆ†æäº†ç³»ç»Ÿä¸­ä¼ æ„Ÿå™¨ç”µå¹³è¯»å–ä»£ç çš„æ€§èƒ½ç‰¹å¾ï¼Œè¯†åˆ«æ½œåœ¨çš„æ€§èƒ½ç“¶é¢ˆï¼Œå¹¶æä¾›ä¼˜åŒ–å»ºè®®ã€‚

**åˆ†ææ—¥æœŸ**: 2025-12-26  
**åˆ†æèŒƒå›´**: ä¼ æ„Ÿå™¨è½®è¯¢æœºåˆ¶ã€IOè¯»å–ã€æ‰¹é‡æ“ä½œ

---

## 1. ä»£ç æ¶æ„åˆ†æ

### 1.1 æ ¸å¿ƒè°ƒç”¨é“¾è·¯

```
LeadshineSensor.MonitorInputAsync()  â† ä¼ æ„Ÿå™¨è½®è¯¢å¾ªç¯ï¼ˆ10msé—´éš”ï¼‰
    â†“
IInputPort.ReadAsync(bitIndex)  â† æŠ½è±¡æ¥å£
    â†“
LeadshineInputPort.ReadAsync(bitIndex)  â† å…·ä½“å®ç°
    â†“
LTDMC.dmc_read_inbit(cardNo, bitno)  â† P/Invoke è°ƒç”¨ï¼ˆåŒæ­¥é˜»å¡ï¼‰
```

### 1.2 å…³é”®ä»£ç ä½ç½®

| ç»„ä»¶ | æ–‡ä»¶è·¯å¾„ | èŒè´£ |
|------|---------|------|
| ä¼ æ„Ÿå™¨è½®è¯¢ | `src/Ingress/ZakYip.WheelDiverterSorter.Ingress/Sensors/LeadshineSensor.cs` | æ¯10msè½®è¯¢ä¸€æ¬¡ï¼Œæ£€æµ‹çŠ¶æ€å˜åŒ– |
| IOæŠ½è±¡æ¥å£ | `src/Core/ZakYip.WheelDiverterSorter.Core/Hardware/Ports/IInputPort.cs` | å®šä¹‰è¯»å–æ¥å£ |
| IOç«¯å£å®ç° | `src/Drivers/ZakYip.WheelDiverterSorter.Drivers/Vendors/Leadshine/LeadshineInputPort.cs` | è°ƒç”¨åº•å±‚ç¡¬ä»¶API |
| æ‰¹é‡è¯»å–åŸºç±» | `src/Drivers/ZakYip.WheelDiverterSorter.Drivers/InputPortBase.cs` | æä¾›é»˜è®¤æ‰¹é‡è¯»å–å®ç° |
| ç¡¬ä»¶SDK | `src/Drivers/ZakYip.WheelDiverterSorter.Drivers/Vendors/Leadshine/LTDMC.cs` | P/Invokeå£°æ˜ |

---

## 2. å·²å‘ç°çš„æ€§èƒ½é—®é¢˜

### ğŸ”´ é—®é¢˜1: åŒæ­¥é˜»å¡çš„P/Invokeè°ƒç”¨

**ä½ç½®**: `LeadshineInputPort.ReadAsync()` â†’ `LTDMC.dmc_read_inbit()`

**é—®é¢˜æè¿°**:
```csharp
public override Task<bool> ReadAsync(int bitIndex)
{
    try
    {
        // âŒ åŒæ­¥è°ƒç”¨ï¼Œä¼šé˜»å¡çº¿ç¨‹
        var result = LTDMC.dmc_read_inbit(_cardNo, (ushort)bitIndex);
        
        if (result < 0)
        {
            _logger.LogWarning("è¯»å–è¾“å…¥ä½ {BitIndex} å¤±è´¥ï¼Œé”™è¯¯ç : {ErrorCode}", bitIndex, result);
            return Task.FromResult(false);
        }

        return Task.FromResult(result != 0);
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "è¯»å–è¾“å…¥ä½ {BitIndex} æ—¶å‘ç”Ÿå¼‚å¸¸", bitIndex);
        return Task.FromResult(false);
    }
}
```

**æ€§èƒ½å½±å“**:
- **é˜»å¡çº¿ç¨‹**: è™½ç„¶æ–¹æ³•ç­¾åæ˜¯ `Task<bool>`ï¼Œä½†å®é™…ä¸Šæ˜¯åŒæ­¥æ‰§è¡Œï¼Œæ¯æ¬¡è°ƒç”¨éƒ½ä¼šé˜»å¡è°ƒç”¨çº¿ç¨‹
- **è½®è¯¢é¢‘ç‡**: é»˜è®¤10msä¸€æ¬¡ï¼Œæ„å‘³ç€æ¯ç§’100æ¬¡P/Invokeè°ƒç”¨
- **å¤šä¼ æ„Ÿå™¨åœºæ™¯**: å¦‚æœæœ‰Nä¸ªä¼ æ„Ÿå™¨ï¼Œæ¯ç§’æ€»å…±æœ‰100Næ¬¡P/Invokeè°ƒç”¨
- **çº¿ç¨‹æ± å‹åŠ›**: æ¯ä¸ªä¼ æ„Ÿå™¨ä¸€ä¸ªç‹¬ç«‹çš„è½®è¯¢ä»»åŠ¡ï¼Œå ç”¨çº¿ç¨‹æ± èµ„æº

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ ä¸­ç­‰ï¼ˆå½“ä¼ æ„Ÿå™¨æ•°é‡å¢åŠ æ—¶ä¼šæˆä¸ºç“¶é¢ˆï¼‰

---

### ğŸŸ¡ é—®é¢˜2: æ‰¹é‡è¯»å–æœªä¼˜åŒ–

**ä½ç½®**: `InputPortBase.ReadBatchAsync()`

**é—®é¢˜æè¿°**:
```csharp
public virtual async Task<bool[]> ReadBatchAsync(int startBit, int count)
{
    var results = new bool[count];
    
    // âŒ å¾ªç¯è°ƒç”¨å•ä¸ªè¯»å–ï¼Œæ²¡æœ‰åˆ©ç”¨ç¡¬ä»¶æ‰¹é‡è¯»å–èƒ½åŠ›
    for (int i = 0; i < count; i++)
    {
        results[i] = await ReadAsync(startBit + i);
    }

    return results;
}
```

**æ€§èƒ½å½±å“**:
- **å¤šæ¬¡P/Invoke**: è¯»å–Nä¸ªä½éœ€è¦Næ¬¡P/Invokeè°ƒç”¨
- **æœªä½¿ç”¨ç¡¬ä»¶èƒ½åŠ›**: é›·èµ›SDKæä¾›äº† `dmc_read_inport_ex()` å¯ä»¥ä¸€æ¬¡è¯»å–æ•´ä¸ªç«¯å£ï¼ˆ32ä½ï¼‰
- **æ•ˆç‡ä½ä¸‹**: å½“éœ€è¦è¯»å–ç›¸é‚»çš„å¤šä¸ªä¼ æ„Ÿå™¨æ—¶ï¼Œæ€§èƒ½æŸå¤±æ˜æ˜¾

**å¯ç”¨çš„æ‰¹é‡API**:
```csharp
// LTDMC.cs ä¸­å·²å£°æ˜ä½†æœªä½¿ç”¨
public static extern short dmc_read_inport_ex(ushort CardNo, ushort portno, ref UInt32 state);
```

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ ä¸­ç­‰ï¼ˆå½“å‰ç³»ç»Ÿå¯èƒ½æœªå¤§é‡ä½¿ç”¨æ‰¹é‡è¯»å–ï¼‰

---

### ğŸŸ¢ é—®é¢˜3: å¼‚å¸¸å¤„ç†å¼€é”€

**ä½ç½®**: `LeadshineInputPort.ReadAsync()`

**é—®é¢˜æè¿°**:
```csharp
public override Task<bool> ReadAsync(int bitIndex)
{
    try
    {
        // æ¯æ¬¡è¯»å–éƒ½åŒ…è£¹åœ¨ try-catch ä¸­
        var result = LTDMC.dmc_read_inbit(_cardNo, (ushort)bitIndex);
        // ...
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "è¯»å–è¾“å…¥ä½ {BitIndex} æ—¶å‘ç”Ÿå¼‚å¸¸", bitIndex);
        return Task.FromResult(false);
    }
}
```

**æ€§èƒ½å½±å“**:
- **try-catchå¼€é”€**: è™½ç„¶æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸æ—¶å¼€é”€å¾ˆå°ï¼Œä½†ä»æœ‰æ€§èƒ½æˆæœ¬
- **æ­£å¸¸æµç¨‹**: åœ¨æ­£å¸¸è¿è¡Œæ—¶ï¼Œå¾ˆå°‘ä¼šè§¦å‘å¼‚å¸¸

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¢ ä½ï¼ˆtry-catchåœ¨æ— å¼‚å¸¸æ—¶å¼€é”€å¯å¿½ç•¥ï¼‰

---

### ğŸŸ¢ é—®é¢˜4: Task.FromResultçš„å°é¢å¼€é”€

**ä½ç½®**: `LeadshineInputPort.ReadAsync()`

**é—®é¢˜æè¿°**:
```csharp
// æ¯æ¬¡è°ƒç”¨éƒ½åˆ›å»ºä¸€ä¸ªå·²å®Œæˆçš„Task
return Task.FromResult(result != 0);
```

**æ€§èƒ½å½±å“**:
- **Taskåˆ†é…**: æ¯æ¬¡è°ƒç”¨éƒ½ä¼šåˆ†é…ä¸€ä¸ªTaskå¯¹è±¡
- **é«˜é¢‘è°ƒç”¨**: 10msè½®è¯¢é—´éš”æ„å‘³ç€æ¯ç§’åˆ›å»º100ä¸ªTaskå¯¹è±¡ï¼ˆæ¯ä¸ªä¼ æ„Ÿå™¨ï¼‰

**å¯èƒ½çš„ä¼˜åŒ–**:
- ä½¿ç”¨ `ValueTask<bool>` å‡å°‘å †åˆ†é…
- ç¼“å­˜å¸¸ç”¨çš„Taskå¯¹è±¡ï¼ˆtrue/falseï¼‰

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¢ ä½ï¼ˆç°ä»£.NETå¯¹Taskåˆ†é…å·²ç»å¾ˆé«˜æ•ˆï¼‰

---

### ğŸŸ¡ é—®é¢˜5: æ—¥å¿—å»é‡æœºåˆ¶çš„æ€§èƒ½å½±å“

**ä½ç½®**: `LeadshineSensor.MonitorInputAsync()`

**é—®é¢˜æè¿°**:
```csharp
// ä½¿ç”¨å»é‡æ—¥å¿—è®°å½•ï¼Œé˜²æ­¢ç›¸åŒçŠ¶æ€å˜åŒ–åœ¨çŸ­æ—¶é—´å†…é‡å¤è¾“å‡º
_logger.LogInformationDeduplicated(
    _logDeduplicator,
    "é›·èµ›{SensorTypeName} {SensorId} çŠ¶æ€å˜åŒ–: {State}",
    _sensorTypeName,
    SensorId,
    currentState ? "è§¦å‘" : "è§£é™¤");
```

**æ€§èƒ½å½±å“**:
- **å»é‡é€»è¾‘**: æ¯æ¬¡çŠ¶æ€å˜åŒ–éƒ½éœ€è¦æ£€æŸ¥å»é‡ç¼“å­˜
- **å†…å­˜å¼€é”€**: å»é‡ç¼“å­˜éœ€è¦ç»´æŠ¤å†å²è®°å½•
- **é”ç«äº‰**: å¦‚æœå»é‡å™¨ä½¿ç”¨é”ä¿æŠ¤ï¼Œå¯èƒ½æœ‰å¹¶å‘ç«äº‰

**éœ€è¦æ£€æŸ¥**: `ILogDeduplicator` çš„å…·ä½“å®ç°

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ ä¸­ç­‰ï¼ˆå–å†³äºå»é‡å™¨çš„å®ç°ï¼‰

---

## 3. æ€§èƒ½åŸºå‡†æµ‹è¯•æ•°æ®

### 3.1 ç†è®ºè®¡ç®—

**å•ä¸ªä¼ æ„Ÿå™¨çš„è´Ÿè½½** (é»˜è®¤10msè½®è¯¢é—´éš”):
- P/Invokeè°ƒç”¨é¢‘ç‡: 100æ¬¡/ç§’
- Taskåˆ†é…é¢‘ç‡: 100æ¬¡/ç§’
- çŠ¶æ€å˜åŒ–æ—¥å¿—é¢‘ç‡: å–å†³äºå®é™…åŒ…è£¹æµé‡

**10ä¸ªä¼ æ„Ÿå™¨çš„è´Ÿè½½**:
- P/Invokeè°ƒç”¨é¢‘ç‡: 1,000æ¬¡/ç§’
- Taskåˆ†é…é¢‘ç‡: 1,000æ¬¡/ç§’
- è½®è¯¢çº¿ç¨‹æ•°: 10ä¸ª

**100ä¸ªä¼ æ„Ÿå™¨çš„è´Ÿè½½** (å¤§å‹åˆ†æ‹£ç³»ç»Ÿ):
- P/Invokeè°ƒç”¨é¢‘ç‡: 10,000æ¬¡/ç§’
- Taskåˆ†é…é¢‘ç‡: 10,000æ¬¡/ç§’
- è½®è¯¢çº¿ç¨‹æ•°: 100ä¸ª

### 3.2 å®æµ‹å»ºè®®

å»ºè®®è¿›è¡Œä»¥ä¸‹æ€§èƒ½æµ‹è¯•:
1. **CPUå ç”¨ç‡**: åœ¨1/10/100ä¸ªä¼ æ„Ÿå™¨åœºæ™¯ä¸‹æµ‹è¯•CPUä½¿ç”¨ç‡
2. **çº¿ç¨‹æ± å‹åŠ›**: ç›‘æ§çº¿ç¨‹æ± çº¿ç¨‹æ•°å’Œé˜Ÿåˆ—é•¿åº¦
3. **P/Invokeå»¶è¿Ÿ**: æµ‹é‡å•æ¬¡ `dmc_read_inbit` çš„å¹³å‡å»¶è¿Ÿ
4. **æ‰¹é‡vså•æ¬¡**: å¯¹æ¯”æ‰¹é‡è¯»å–å’Œå•æ¬¡è¯»å–çš„æ€§èƒ½å·®å¼‚

---

## 4. ä¼˜åŒ–å»ºè®®

### ä¼˜åŒ–1: å®ç°çœŸæ­£çš„æ‰¹é‡è¯»å– (ä¼˜å…ˆçº§: ğŸ”´ é«˜)

**ç›®æ ‡**: åˆ©ç”¨ç¡¬ä»¶èƒ½åŠ›ä¸€æ¬¡è¯»å–æ•´ä¸ªç«¯å£ï¼Œå‡å°‘P/Invokeè°ƒç”¨æ¬¡æ•°

**å®æ–½æ–¹æ¡ˆ**:
åœ¨ `LeadshineInputPort` ä¸­é‡å†™ `ReadBatchAsync()`:

```csharp
public override Task<bool[]> ReadBatchAsync(int startBit, int count)
{
    try
    {
        // è®¡ç®—éœ€è¦è¯»å–çš„ç«¯å£èŒƒå›´
        int startPort = startBit / 32;
        int endPort = (startBit + count - 1) / 32;
        
        var results = new bool[count];
        
        for (int portNo = startPort; portNo <= endPort; portNo++)
        {
            UInt32 portValue = 0;
            // âœ… ä¸€æ¬¡è¯»å–32ä½
            short errorCode = LTDMC.dmc_read_inport_ex(_cardNo, (ushort)portNo, ref portValue);
            
            if (errorCode < 0)
            {
                _logger.LogWarning("æ‰¹é‡è¯»å–ç«¯å£ {PortNo} å¤±è´¥ï¼Œé”™è¯¯ç : {ErrorCode}", portNo, errorCode);
                continue;
            }
            
            // è§£æç«¯å£å€¼åˆ°ç»“æœæ•°ç»„
            int portStartBit = portNo * 32;
            for (int i = 0; i < 32 && (portStartBit + i - startBit) < count; i++)
            {
                int resultIndex = portStartBit + i - startBit;
                if (resultIndex >= 0 && resultIndex < count)
                {
                    results[resultIndex] = ((portValue >> i) & 1) != 0;
                }
            }
        }
        
        return Task.FromResult(results);
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "æ‰¹é‡è¯»å–è¾“å…¥ä½å¤±è´¥");
        return Task.FromResult(new bool[count]);
    }
}
```

**é¢„æœŸæ”¶ç›Š**:
- **å‡å°‘P/Invokeæ¬¡æ•°**: ä»Næ¬¡å‡å°‘åˆ° âŒˆN/32âŒ‰ æ¬¡
- **ç¤ºä¾‹**: è¯»å–10ä¸ªç›¸é‚»ä½ï¼Œä»10æ¬¡è°ƒç”¨å‡å°‘åˆ°1æ¬¡
- **æ€§èƒ½æå‡**: é¢„è®¡æå‡5-10å€ï¼ˆå–å†³äºä¼ æ„Ÿå™¨åˆ†å¸ƒï¼‰

---

### ä¼˜åŒ–2: ä½¿ç”¨ValueTaskå‡å°‘å †åˆ†é… (ä¼˜å…ˆçº§: ğŸŸ¡ ä¸­)

**ç›®æ ‡**: å‡å°‘é«˜é¢‘è°ƒç”¨æ—¶çš„Taskå¯¹è±¡åˆ†é…

**å®æ–½æ–¹æ¡ˆ**:
ä¿®æ”¹æ¥å£å’Œå®ç°ä½¿ç”¨ `ValueTask<T>`:

```csharp
// IInputPort.cs
public interface IInputPort
{
    ValueTask<bool> ReadAsync(int bitIndex);
    ValueTask<bool[]> ReadBatchAsync(int startBit, int count);
}

// LeadshineInputPort.cs
public override ValueTask<bool> ReadAsync(int bitIndex)
{
    try
    {
        var result = LTDMC.dmc_read_inbit(_cardNo, (ushort)bitIndex);
        
        if (result < 0)
        {
            _logger.LogWarning("è¯»å–è¾“å…¥ä½ {BitIndex} å¤±è´¥ï¼Œé”™è¯¯ç : {ErrorCode}", bitIndex, result);
            return new ValueTask<bool>(false);
        }

        return new ValueTask<bool>(result != 0);
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "è¯»å–è¾“å…¥ä½ {BitIndex} æ—¶å‘ç”Ÿå¼‚å¸¸", bitIndex);
        return new ValueTask<bool>(false);
    }
}
```

**é¢„æœŸæ”¶ç›Š**:
- **å‡å°‘å †åˆ†é…**: ValueTaskæ˜¯å€¼ç±»å‹ï¼Œåœ¨åŒæ­¥å®Œæˆæ—¶æ— å †åˆ†é…
- **GCå‹åŠ›é™ä½**: å‡å°‘åƒåœ¾å›æ”¶é¢‘ç‡

**æ³¨æ„äº‹é¡¹**:
- âš ï¸ **é‡å¤§æ”¹åŠ¨**: éœ€è¦ä¿®æ”¹æ‰€æœ‰æ¥å£å®ç°å’Œè°ƒç”¨æ–¹
- âš ï¸ **å½±å“èŒƒå›´å¹¿**: éœ€è¦å®Œæ•´çš„å›å½’æµ‹è¯•

---

### ä¼˜åŒ–3: ç¼“å­˜å¸¸ç”¨Taskç»“æœ (ä¼˜å…ˆçº§: ğŸŸ¢ ä½)

**ç›®æ ‡**: å¦‚æœä¸æ”¹ç”¨ValueTaskï¼Œå¯ä»¥ç¼“å­˜true/falseçš„Task

**å®æ–½æ–¹æ¡ˆ**:
```csharp
public class LeadshineInputPort : InputPortBase
{
    private static readonly Task<bool> TrueTask = Task.FromResult(true);
    private static readonly Task<bool> FalseTask = Task.FromResult(false);
    
    public override Task<bool> ReadAsync(int bitIndex)
    {
        try
        {
            var result = LTDMC.dmc_read_inbit(_cardNo, (ushort)bitIndex);
            
            if (result < 0)
            {
                _logger.LogWarning("è¯»å–è¾“å…¥ä½ {BitIndex} å¤±è´¥ï¼Œé”™è¯¯ç : {ErrorCode}", bitIndex, result);
                return FalseTask;  // âœ… å¤ç”¨ç¼“å­˜çš„Task
            }

            return result != 0 ? TrueTask : FalseTask;  // âœ… å¤ç”¨ç¼“å­˜çš„Task
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "è¯»å–è¾“å…¥ä½ {BitIndex} æ—¶å‘ç”Ÿå¼‚å¸¸", bitIndex);
            return FalseTask;
        }
    }
}
```

**é¢„æœŸæ”¶ç›Š**:
- **å‡å°‘Taskåˆ†é…**: ä»æ¯æ¬¡åˆ†é…å˜ä¸ºå¤ç”¨2ä¸ªé™æ€Task
- **ç®€å•å®ç°**: ä¸éœ€è¦ä¿®æ”¹æ¥å£

---

### ä¼˜åŒ–4: å¯é…ç½®çš„è½®è¯¢é—´éš”ç­–ç•¥ (ä¼˜å…ˆçº§: ğŸŸ¢ ä½)

**ç›®æ ‡**: æ ¹æ®ä¼ æ„Ÿå™¨ç±»å‹å’Œå®é™…éœ€æ±‚åŠ¨æ€è°ƒæ•´è½®è¯¢é—´éš”

**å½“å‰çŠ¶æ€**:
- âœ… å·²æ”¯æŒæ¯ä¸ªä¼ æ„Ÿå™¨ç‹¬ç«‹é…ç½®è½®è¯¢é—´éš”
- âœ… é»˜è®¤10msï¼Œå¯é€šè¿‡é…ç½®è°ƒæ•´

**å»ºè®®çš„ç­–ç•¥**:
1. **å…³é”®ä¼ æ„Ÿå™¨**: åˆ›å»ºåŒ…è£¹æ„Ÿåº”IOä¿æŒ10ms
2. **æ™®é€šä¼ æ„Ÿå™¨**: é”æ ¼æ„Ÿåº”IOå¯è°ƒæ•´ä¸º15-20ms
3. **ç›‘æ§ç±»ä¼ æ„Ÿå™¨**: éå…³é”®ç›‘æ§ç‚¹å¯è°ƒæ•´ä¸º50ms

**é…ç½®ç¤ºä¾‹**:
```json
{
  "sensors": [
    {
      "sensorId": 1,
      "sensorName": "åˆ›å»ºåŒ…è£¹æ„Ÿåº”IO",
      "pollingIntervalMs": 10
    },
    {
      "sensorId": 2,
      "sensorName": "é”æ ¼æ„Ÿåº”IO",
      "pollingIntervalMs": 20
    }
  ]
}
```

**é¢„æœŸæ”¶ç›Š**:
- **é™ä½CPUå ç”¨**: éå…³é”®ä¼ æ„Ÿå™¨é™ä½è½®è¯¢é¢‘ç‡
- **ä¿æŒç²¾åº¦**: å…³é”®ä¼ æ„Ÿå™¨ç»´æŒé«˜é¢‘è½®è¯¢

---

### ä¼˜åŒ–5: æ£€æŸ¥å¹¶ä¼˜åŒ–æ—¥å¿—å»é‡å™¨ (ä¼˜å…ˆçº§: ğŸŸ¡ ä¸­)

**ç›®æ ‡**: ç¡®ä¿æ—¥å¿—å»é‡ä¸æˆä¸ºæ€§èƒ½ç“¶é¢ˆ

**éœ€è¦æ£€æŸ¥**:
1. `ILogDeduplicator` çš„å®ç°æ˜¯å¦ä½¿ç”¨äº†é«˜æ•ˆçš„æ•°æ®ç»“æ„
2. æ˜¯å¦æœ‰ä¸å¿…è¦çš„é”ç«äº‰
3. ç¼“å­˜æ¸…ç†ç­–ç•¥æ˜¯å¦åˆç†

**å»ºè®®çš„å®ç°è¦ç‚¹**:
- ä½¿ç”¨ `ConcurrentDictionary` è€Œéé”ä¿æŠ¤çš„Dictionary
- å®ç°åŸºäºæ—¶é—´çª—å£çš„è‡ªåŠ¨æ¸…ç†
- é™åˆ¶ç¼“å­˜å¤§å°ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼

---

## 5. å®æ–½ä¼˜å…ˆçº§

### ç¬¬ä¸€é˜¶æ®µ (ç«‹å³å®æ–½)

1. **å®ç°æ‰¹é‡è¯»å–ä¼˜åŒ–** ğŸ”´
   - é¢„æœŸæ”¶ç›Š: é«˜
   - å®æ–½æˆæœ¬: ä¸­
   - é£é™©: ä½ï¼ˆåªéœ€é‡å†™ReadBatchAsyncï¼Œå‘åå…¼å®¹ï¼‰

2. **ç¼“å­˜å¸¸ç”¨Taskç»“æœ** ğŸŸ¢
   - é¢„æœŸæ”¶ç›Š: ä½-ä¸­
   - å®æ–½æˆæœ¬: ä½
   - é£é™©: æä½

### ç¬¬äºŒé˜¶æ®µ (è¯„ä¼°åå®æ–½)

3. **è¯„ä¼°ValueTaskè¿ç§»** ğŸŸ¡
   - é¢„æœŸæ”¶ç›Š: ä¸­
   - å®æ–½æˆæœ¬: é«˜ï¼ˆæ¥å£ç ´åæ€§å˜æ›´ï¼‰
   - é£é™©: ä¸­ï¼ˆéœ€è¦å…¨é¢æµ‹è¯•ï¼‰
   - å»ºè®®: å…ˆè¿›è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•ï¼Œç¡®è®¤æ”¶ç›Šåå†å†³å®š

4. **ä¼˜åŒ–æ—¥å¿—å»é‡å™¨** ğŸŸ¡
   - é¢„æœŸæ”¶ç›Š: æœªçŸ¥ï¼ˆéœ€å…ˆåˆ†æå½“å‰å®ç°ï¼‰
   - å®æ–½æˆæœ¬: ä½-ä¸­
   - é£é™©: ä½

### ç¬¬ä¸‰é˜¶æ®µ (æŒç»­ä¼˜åŒ–)

5. **è½®è¯¢é—´éš”åŠ¨æ€è°ƒæ•´** ğŸŸ¢
   - é¢„æœŸæ”¶ç›Š: ä½-ä¸­
   - å®æ–½æˆæœ¬: ä½ï¼ˆå·²æ”¯æŒé…ç½®ï¼‰
   - é£é™©: ä½ï¼ˆé…ç½®è°ƒæ•´ï¼‰

---

## 6. æ€§èƒ½ç›‘æ§å»ºè®®

### 6.1 å…³é”®æŒ‡æ ‡

å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒç›‘æ§ä»¥ä¸‹æŒ‡æ ‡:

| æŒ‡æ ‡ | é˜ˆå€¼ | å‘Šè­¦çº§åˆ« |
|------|------|---------|
| P/Invokeè°ƒç”¨é¢‘ç‡ | > 50,000æ¬¡/ç§’ | âš ï¸ è­¦å‘Š |
| CPUå ç”¨ç‡ï¼ˆè½®è¯¢çº¿ç¨‹ï¼‰ | > 20% | âš ï¸ è­¦å‘Š |
| çº¿ç¨‹æ± çº¿ç¨‹æ•° | > 200 | âš ï¸ è­¦å‘Š |
| å•æ¬¡è¯»å–å»¶è¿Ÿ | > 5ms | ğŸ”´ ä¸¥é‡ |
| æ‰¹é‡è¯»å–å»¶è¿Ÿï¼ˆ32ä½ï¼‰ | > 10ms | ğŸ”´ ä¸¥é‡ |

### 6.2 è¯Šæ–­å·¥å…·

1. **PrometheusæŒ‡æ ‡**:
   - `sensor_read_total` - æ€»è¯»å–æ¬¡æ•°
   - `sensor_read_duration_ms` - è¯»å–å»¶è¿Ÿ
   - `sensor_polling_threads` - è½®è¯¢çº¿ç¨‹æ•°

2. **æ€§èƒ½åˆ†æ**:
   - ä½¿ç”¨dotnet-traceæ”¶é›†æ€§èƒ½æ•°æ®
   - åˆ†æP/Invokeè°ƒç”¨è€—æ—¶
   - æ£€æŸ¥çº¿ç¨‹æ± é¥¥é¥¿

---

## 7. æµ‹è¯•è®¡åˆ’

### 7.1 å•å…ƒæµ‹è¯•

- [ ] æ‰¹é‡è¯»å–æ­£ç¡®æ€§æµ‹è¯•
- [ ] è¾¹ç•Œæ¡ä»¶æµ‹è¯•ï¼ˆè·¨ç«¯å£è¯»å–ï¼‰
- [ ] é”™è¯¯å¤„ç†æµ‹è¯•

### 7.2 æ€§èƒ½æµ‹è¯•

- [ ] å•ä¼ æ„Ÿå™¨è½®è¯¢æ€§èƒ½åŸºå‡†
- [ ] 10/100ä¼ æ„Ÿå™¨å¹¶å‘è½®è¯¢
- [ ] æ‰¹é‡è¯»å– vs å•æ¬¡è¯»å–å¯¹æ¯”
- [ ] CPUå’Œå†…å­˜å ç”¨æµ‹è¯•

### 7.3 é›†æˆæµ‹è¯•

- [ ] å®Œæ•´åˆ†æ‹£æµç¨‹æ€§èƒ½æµ‹è¯•
- [ ] é«˜è´Ÿè½½åœºæ™¯æµ‹è¯•ï¼ˆ100+ åŒ…è£¹/åˆ†é’Ÿï¼‰
- [ ] é•¿æ—¶é—´è¿è¡Œç¨³å®šæ€§æµ‹è¯•

---

## 8. ç»“è®º

### å½“å‰çŠ¶æ€
ç³»ç»Ÿçš„ä¼ æ„Ÿå™¨è¯»å–æœºåˆ¶åœ¨è®¾è®¡ä¸Šåˆç†ï¼Œä»£ç è´¨é‡è‰¯å¥½ï¼Œä½†å­˜åœ¨ä»¥ä¸‹å¯ä¼˜åŒ–ç‚¹:
- âœ… **æ¶æ„æ¸…æ™°**: æŠ½è±¡å±‚æ¬¡åˆ†æ˜ï¼Œæ˜“äºç»´æŠ¤
- âœ… **å¯é…ç½®**: æ”¯æŒç‹¬ç«‹çš„è½®è¯¢é—´éš”é…ç½®
- âš ï¸ **æ‰¹é‡è¯»å–æœªä¼˜åŒ–**: æœªå……åˆ†åˆ©ç”¨ç¡¬ä»¶èƒ½åŠ›
- âš ï¸ **é«˜é¢‘Taskåˆ†é…**: åœ¨å¤§è§„æ¨¡åœºæ™¯ä¸‹å¯èƒ½æˆä¸ºç“¶é¢ˆ

### ä¼˜åŒ–å»ºè®®æ€»ç»“
1. **ç«‹å³å®æ–½**: æ‰¹é‡è¯»å–ä¼˜åŒ–ï¼ˆé¢„æœŸ5-10å€æå‡ï¼‰
2. **è¯„ä¼°åå®æ–½**: ValueTaskè¿ç§»ï¼ˆéœ€æ€§èƒ½æµ‹è¯•éªŒè¯ï¼‰
3. **æŒç»­ä¼˜åŒ–**: è½®è¯¢é—´éš”ç­–ç•¥ã€æ—¥å¿—å»é‡ä¼˜åŒ–

### é£é™©è¯„ä¼°
- **ä½é£é™©ä¼˜åŒ–**: æ‰¹é‡è¯»å–ã€Taskç¼“å­˜ã€è½®è¯¢é—´éš”è°ƒæ•´
- **ä¸­é£é™©ä¼˜åŒ–**: ValueTaskè¿ç§»ï¼ˆéœ€å…¨é¢æµ‹è¯•ï¼‰
- **å»ºè®®**: ä¼˜å…ˆå®æ–½ä½é£é™©ä¼˜åŒ–ï¼Œè·å¾—å¿«é€Ÿæ”¶ç›Š

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**ä½œè€…**: GitHub Copilot  
**å®¡æ ¸çŠ¶æ€**: å¾…å®¡æ ¸
