# 配置管理完整指南

## 概述

本文档提供 ZakYip.WheelDiverterSorter 系统所有配置的完整说明，包括配置层次、使用场景、API 端点和最佳实践。

## 一、配置层次结构

系统配置按职责分为三个层次：

```
┌─────────────────────────────────────────┐
│    拓扑配置 (Topology Configuration)     │  ← 物理层：定义"有哪些设备"
│    /api/config/topology                 │     低频变化（硬件变更时）
└─────────────────────────────────────────┘
              ↓ 引用关系
┌─────────────────────────────────────────┐
│    路由配置 (Route Configuration)       │  ← 业务层：定义"如何使用设备"
│    /api/config/routes                   │     较高频变化（规则调整时）
└─────────────────────────────────────────┘
              ↓ 配合使用
┌─────────────────────────────────────────┐
│    面板配置 (Panel Configuration)       │  ← 交互层：定义"如何操作系统"
│    /api/config/panel                    │     按需调整（操作方式变更时）
└─────────────────────────────────────────┘
```

### 1.1 拓扑配置（物理层）

**职责**：定义物理设备的存在和连接关系

**包含内容**：
- 摆轮节点列表（有哪些摆轮）
- 格口列表（有哪些格口）
- 物理连接关系（设备如何连接）
- 硬件参数（电机类型、传感器类型等）

**变更频率**：低频（仅在硬件安装、设备增减、线体改造时变更）

**修改方式**：当前通过编辑 JSON 配置文件，重启服务生效

**API 端点**：`/api/config/topology`

### 1.2 路由配置（业务层）

**职责**：定义如何使用设备完成分拣任务

**包含内容**：
- 格口路由规则（包裹分拣到哪个格口）
- 摆轮切换序列（摆轮按什么顺序切换）
- 摆轮方向配置（每个摆轮向哪个方向切换）
- 时序参数（容错时间、段速度等）
- 感应器配置（用哪个感应器触发）

**变更频率**：较高频（业务规则调整、优化分拣路径时变更）

**修改方式**：通过 API 动态更新，立即生效，无需重启

**API 端点**：`/api/config/routes`

### 1.3 面板配置（交互层）

**职责**：定义如何与系统交互（操作面板行为）

**包含内容**：
- 是否启用面板功能
- 是否使用仿真模式
- 按钮轮询间隔
- 按钮防抖时间

**变更频率**：按需调整（操作方式变更、性能优化时变更）

**修改方式**：通过 API 动态更新，立即生效

**API 端点**：`/api/config/panel`

## 二、配置关系与边界

### 2.1 拓扑配置 vs 路由配置

**关键区别**：

| 维度 | 拓扑配置 | 路由配置 |
|------|---------|---------|
| **职责** | 定义"有哪些设备" | 定义"如何使用设备" |
| **语义** | 物理存在和连接 | 业务规则和逻辑 |
| **变更频率** | 低频（硬件变更） | 较高频（规则调整） |
| **更新方式** | 配置文件 + 重启 | API 热更新 |
| **独有信息** | 物理连接关系、硬件类型 | 摆轮方向、顺序号、容错时间 |

**依赖关系**：
- 路由配置**引用**拓扑配置中定义的格口ID和摆轮ID
- 创建路由配置前，必须确保对应的格口和摆轮已在拓扑配置中定义

**使用建议**：
- ✅ 日常业务调整：仅修改路由配置
- ✅ 硬件增减：修改拓扑配置，然后更新相关路由配置
- ❌ 不要在路由配置中引用不存在的格口或摆轮

### 2.2 配置使用场景

#### 场景1：初始部署

```bash
# 1. 配置拓扑（定义硬件）
编辑 topology.json
重启服务

# 2. 配置路由（定义规则）
POST /api/config/routes
{
  "chuteId": 1,
  "diverterConfigurations": [...]
}

# 3. 配置面板（定义交互）
PUT /api/config/panel
{
  "enabled": true,
  "useSimulation": true,
  "pollingIntervalMs": 100,
  "debounceMs": 50
}
```

#### 场景2：日常业务调整

```bash
# 仅修改路由配置
PUT /api/config/routes/1
{
  "chuteId": 1,
  "diverterConfigurations": [...]  # 调整摆轮序列或方向
}

# 无需重启，立即生效
```

#### 场景3：硬件增减

```bash
# 1. 修改拓扑配置
编辑 topology.json  # 添加新的摆轮节点
重启服务

# 2. 更新路由配置
POST /api/config/routes
{
  "chuteId": 10,
  "diverterConfigurations": [
    {"diverterId": 新增的摆轮ID, ...}
  ]
}
```

## 三、API 端点详解

### 3.1 拓扑配置 API

#### 查询拓扑配置

```http
GET /api/config/topology
```

**响应示例**：
```json
{
  "topologyId": "main-line-001",
  "wheelNodes": [
    {
      "nodeId": 1,
      "nodeName": "摆轮1",
      ...
    }
  ],
  "chutes": [
    {
      "chuteId": 1,
      "chuteName": "A区01号口",
      ...
    }
  ]
}
```

#### 更新拓扑配置

```http
PUT /api/config/topology
```

**状态**：当前返回 501（未实现），需要通过配置文件修改

### 3.2 路由配置 API

#### 查询所有路由

```http
GET /api/config/routes
```

#### 查询单个路由

```http
GET /api/config/routes/{chuteId}
```

#### 创建路由

```http
POST /api/config/routes
Content-Type: application/json

{
  "chuteId": 1,
  "chuteName": "A区01号口",
  "diverterConfigurations": [
    {
      "diverterId": 1,
      "targetDirection": "Left",
      "sequenceNumber": 1,
      "segmentLengthMm": 5000.0,
      "segmentSpeedMmPerSecond": 1000.0,
      "segmentToleranceTimeMs": 2000
    }
  ],
  "beltSpeedMmPerSecond": 1000.0,
  "beltLengthMm": 10000.0,
  "toleranceTimeMs": 2000,
  "isEnabled": true
}
```

#### 更新路由

```http
PUT /api/config/routes/{chuteId}
Content-Type: application/json

{路由配置对象}
```

#### 删除路由

```http
DELETE /api/config/routes/{chuteId}
```

#### 导出路由

```http
GET /api/config/routes/export
```

#### 导入路由

```http
POST /api/config/routes/import
Content-Type: application/json

[{路由配置对象1}, {路由配置对象2}, ...]
```

### 3.3 面板配置 API

#### 查询面板配置

```http
GET /api/config/panel
```

**响应示例**：
```json
{
  "enabled": true,
  "useSimulation": true,
  "pollingIntervalMs": 100,
  "debounceMs": 50
}
```

#### 更新面板配置

```http
PUT /api/config/panel
Content-Type: application/json

{
  "enabled": true,
  "useSimulation": true,
  "pollingIntervalMs": 100,
  "debounceMs": 50
}
```

**参数约束**：
- `pollingIntervalMs`: 50-1000 毫秒
- `debounceMs`: 10-500 毫秒
- `debounceMs` 必须小于 `pollingIntervalMs`

#### 重置为默认配置

```http
POST /api/config/panel/reset
```

#### 获取配置模板

```http
GET /api/config/panel/template
```

## 四、配置最佳实践

### 4.1 配置变更流程

```
┌─────────────────────┐
│  评估变更需求        │
└──────────┬──────────┘
           ↓
    ┌──────┴──────┐
    │ 需要硬件变更？│
    └──────┬──────┘
      是 ↙   ↘ 否
   ┌────┴────┐  ┌────┴────┐
   │修改拓扑配置│  │修改路由配置│
   │ + 重启服务│  │  (API)    │
   └────┬────┘  └────┬────┘
        ↓              ↓
   ┌────┴──────────────┴────┐
   │   更新相关路由配置       │
   │     (如有必要)          │
   └────────┬────────────────┘
            ↓
   ┌────────┴────────┐
   │   验证配置生效   │
   └─────────────────┘
```

### 4.2 配置管理建议

#### ✅ 推荐做法

1. **分层管理**：
   - 拓扑配置：由系统管理员管理，变更需审批
   - 路由配置：由业务人员管理，允许频繁调整
   - 面板配置：由操作人员管理，按需优化

2. **版本控制**：
   - 使用导出功能定期备份路由配置
   - 重大变更前先导出当前配置
   - 变更后验证无误再提交

3. **渐进式变更**：
   - 先在测试环境验证
   - 然后在单个格口上测试
   - 最后推广到所有格口

4. **文档记录**：
   - 记录每次变更的原因和时间
   - 保留变更前后的配置快照
   - 记录变更后的效果评估

#### ❌ 避免做法

1. **直接生产变更**：
   - ❌ 不在测试环境验证就直接修改生产配置
   - ❌ 不备份就进行大规模配置变更

2. **频繁重启**：
   - ❌ 为了调整业务规则而频繁重启服务
   - ✅ 应该使用路由配置 API 进行热更新

3. **配置不一致**：
   - ❌ 拓扑配置和路由配置不匹配
   - ❌ 路由配置引用不存在的格口或摆轮

4. **缺少验证**：
   - ❌ 变更后不验证是否生效
   - ❌ 不监控变更后的系统表现

### 4.3 配置验证清单

在进行配置变更后，使用以下清单验证：

#### 拓扑配置验证

- [ ] 所有摆轮节点已定义
- [ ] 所有格口已定义
- [ ] 物理连接关系正确
- [ ] 硬件参数匹配实际设备
- [ ] 重启后系统正常启动

#### 路由配置验证

- [ ] 引用的格口ID在拓扑中存在
- [ ] 引用的摆轮ID在拓扑中存在
- [ ] 摆轮序列号连续且从1开始
- [ ] 没有重复的路由配置
- [ ] 时序参数合理
- [ ] 配置立即生效

#### 面板配置验证

- [ ] 轮询间隔在有效范围内（50-1000ms）
- [ ] 防抖时间在有效范围内（10-500ms）
- [ ] 防抖时间小于轮询间隔
- [ ] 仿真/硬件模式切换正确
- [ ] 按钮响应符合预期

## 五、故障排查

### 5.1 常见问题

#### 问题1：路由配置保存失败

**可能原因**：
- 引用的格口ID不存在于拓扑配置
- 引用的摆轮ID不存在于拓扑配置
- 摆轮序列号不连续或不从1开始
- 存在重复的路由配置

**解决方法**：
1. 查询拓扑配置，确认格口和摆轮ID
2. 检查摆轮序列号是否连续
3. 查询现有路由配置，避免重复

#### 问题2：配置更新不生效

**可能原因**：
- 修改了拓扑配置但未重启服务
- API 调用失败但未检查返回值
- 缓存未刷新

**解决方法**：
1. 拓扑配置变更后必须重启服务
2. 检查 API 返回的状态码和错误信息
3. 查询配置确认已更新

#### 问题3：面板配置参数被拒绝

**可能原因**：
- 参数超出有效范围
- 防抖时间大于或等于轮询间隔

**解决方法**：
1. 检查参数约束：
   - 轮询间隔：50-1000ms
   - 防抖时间：10-500ms
   - 防抖时间 < 轮询间隔
2. 使用模板端点获取有效配置示例

### 5.2 调试技巧

#### 1. 查看当前配置

```bash
# 查看拓扑配置
curl http://localhost:5000/api/config/topology

# 查看所有路由配置
curl http://localhost:5000/api/config/routes

# 查看面板配置
curl http://localhost:5000/api/config/panel
```

#### 2. 验证配置引用关系

```bash
# 1. 查询拓扑，记录所有格口ID和摆轮ID
curl http://localhost:5000/api/config/topology | jq '.chutes[].chuteId'

# 2. 查询路由，检查是否引用了不存在的ID
curl http://localhost:5000/api/config/routes | jq '.[].chuteId'
```

#### 3. 导出配置备份

```bash
# 导出路由配置
curl http://localhost:5000/api/config/routes/export > routes_backup.json

# 查看导出的配置
cat routes_backup.json | jq '.'
```

## 六、相关文档

- **路由配置拓扑配置收敛分析**：`docs/pr-summaries/PRXX_路由配置拓扑配置收敛分析.md`
- **面板配置与仿真API使用指南**：`docs/guides/面板配置与仿真API使用指南.md`
- **API 清单**：`docs/internal/API_INVENTORY.md`
- **系统配置指南**：`docs/guides/SYSTEM_CONFIG_GUIDE.md`

## 七、总结

### 关键要点

1. **配置层次清晰**：拓扑（物理）→ 路由（业务）→ 面板（交互）
2. **职责不重叠**：各层配置职责明确，互不干扰
3. **变更频率不同**：拓扑低频、路由高频、面板按需
4. **更新方式不同**：拓扑重启生效、路由热更新、面板热更新

### 使用原则

- ✅ 优先使用 API 进行配置变更
- ✅ 变更前备份现有配置
- ✅ 在测试环境验证后再上生产
- ✅ 变更后进行完整的功能验证

### 联系与支持

如有配置相关问题，请：
1. 查阅本文档和相关文档
2. 检查日志输出
3. 联系技术支持团队

---

**文档版本**：1.0  
**创建日期**：2025-11-21  
**作者**：GitHub Copilot  
**维护**：ZakYip Development Team
