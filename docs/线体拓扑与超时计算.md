# 线体拓扑与超时计算说明

## 概述

本文档说明如何使用线体拓扑配置进行路径距离和超时计算，以支持包裹的准时到达监控和丢失检测。

## 一、线体拓扑模型

### 1.1 核心概念

#### 节点（Node）
- **入口节点（ENTRY）**: 包裹进入系统的起点
- **摆轮节点（WheelNode）**: 分拣线上的摆轮设备，可以将包裹导向不同方向
- **格口节点（Chute）**: 包裹的最终落格点

#### 线体段（LineSegment）
连接两个节点之间的物理线体段，包含以下信息：
- `SegmentId`: 线体段唯一标识
- `FromNodeId`: 起始节点ID
- `ToNodeId`: 目标节点ID  
- `LengthMm`: 线体段物理长度（毫米）
- `NominalSpeedMmPerSec`: 标称运行速度（毫米/秒）

#### 格口映射（ChuteMapping）
定义格口与摆轮节点的绑定关系：
- `ChuteId`: 格口ID
- `BoundNodeId`: 绑定的摆轮节点ID
- `BoundDirection`: 绑定的摆轮方向（Left/Right/Straight）
- `DropOffsetMm`: 摆轮动作点到实际落格点的距离偏移

### 1.2 拓扑配置示例

```json
{
  "topologyName": "标准三摆轮线体",
  "description": "包含3个摆轮和6个格口的标准配置",
  "wheelNodes": [
    {
      "nodeId": "WHEEL-1",
      "nodeName": "第一摆轮",
      "positionIndex": 1,
      "hasLeftChute": true,
      "hasRightChute": true
    },
    {
      "nodeId": "WHEEL-2",
      "nodeName": "第二摆轮",
      "positionIndex": 2,
      "hasLeftChute": true,
      "hasRightChute": true
    },
    {
      "nodeId": "WHEEL-3",
      "nodeName": "第三摆轮",
      "positionIndex": 3,
      "hasLeftChute": true,
      "hasRightChute": false
    }
  ],
  "chutes": [
    {
      "chuteId": "CHUTE-001",
      "chuteName": "A区01号口",
      "isExceptionChute": false,
      "boundNodeId": "WHEEL-1",
      "boundDirection": "Left",
      "dropOffsetMm": 500.0,
      "isEnabled": true
    },
    {
      "chuteId": "CHUTE-002",
      "chuteName": "A区02号口",
      "boundNodeId": "WHEEL-1",
      "boundDirection": "Right",
      "dropOffsetMm": 500.0
    }
  ],
  "lineSegments": [
    {
      "segmentId": "ENTRY-TO-WHEEL1",
      "fromNodeId": "ENTRY",
      "toNodeId": "WHEEL-1",
      "lengthMm": 5000.0,
      "nominalSpeedMmPerSec": 1000.0,
      "description": "入口到第一个摆轮"
    },
    {
      "segmentId": "WHEEL1-TO-WHEEL2",
      "fromNodeId": "WHEEL-1",
      "toNodeId": "WHEEL-2",
      "lengthMm": 4000.0,
      "nominalSpeedMmPerSec": 1000.0,
      "description": "第一摆轮到第二摆轮"
    },
    {
      "segmentId": "WHEEL2-TO-WHEEL3",
      "fromNodeId": "WHEEL-2",
      "toNodeId": "WHEEL-3",
      "lengthMm": 4000.0,
      "nominalSpeedMmPerSec": 1000.0,
      "description": "第二摆轮到第三摆轮"
    }
  ],
  "entrySensorId": "SENSOR-ENTRY",
  "exitSensorId": "SENSOR-EXIT",
  "defaultLineSpeedMmps": 1000.0
}
```

## 二、路径计算

### 2.1 路径查询

对于任意格口ID，系统可以查询从入口到该格口的完整路径：

```csharp
var topology = _topologyRepository.Get();
var path = topology.GetPathToChute("CHUTE-002");
// 返回：[ENTRY->WHEEL-1]
```

对于绑定到第二个摆轮的格口：
```csharp
var path = topology.GetPathToChute("CHUTE-003");
// 返回：[ENTRY->WHEEL-1, WHEEL-1->WHEEL-2]
```

### 2.2 距离计算

路径总距离 = 所有线体段长度之和 + 落格偏移距离

```
TotalDistance = Σ(Segment.LengthMm) + Chute.DropOffsetMm
```

示例：
```
CHUTE-001 总距离 = 5000 (ENTRY->WHEEL-1) + 500 (DropOffset) = 5500 mm
CHUTE-003 总距离 = 5000 (ENTRY->WHEEL-1) + 4000 (WHEEL-1->WHEEL-2) + 500 (DropOffset) = 9500 mm
```

### 2.3 时间计算

理论到达时间（毫秒）：

```
EstimatedArrivalTime = Σ(Segment.LengthMm / Segment.SpeedMmPerSec) * 1000 + (DropOffsetMm / Speed) * 1000
```

示例（使用标称速度 1000 mm/s）：
```
CHUTE-001 到达时间 = (5000/1000)*1000 + (500/1000)*1000 = 5000 + 500 = 5500 ms
CHUTE-003 到达时间 = (5000/1000)*1000 + (4000/1000)*1000 + (500/1000)*1000 = 9500 ms
```

## 三、超时与丢失判定

### 3.1 超时阈值计算

超时阈值 = 理论到达时间 × 容忍系数

```
TimeoutThreshold = EstimatedArrivalTime × ToleranceFactor
```

推荐的容忍系数：
- **正常情况**: 1.5 倍（150%）
- **高负载情况**: 2.0 倍（200%）
- **调试模式**: 3.0 倍（300%）

示例（使用 1.5 倍容忍系数）：
```
CHUTE-001 超时阈值 = 5500 * 1.5 = 8250 ms
CHUTE-003 超时阈值 = 9500 * 1.5 = 14250 ms
```

### 3.2 包裹状态判定

根据包裹的实际到达时间和理论时间，判定包裹状态：

```
如果 ActualArrivalTime ≤ EstimatedArrivalTime * 0.8:
    状态 = 提前到达（可能发生擦肩或跳包）
    
如果 EstimatedArrivalTime * 0.8 < ActualArrivalTime ≤ TimeoutThreshold:
    状态 = 正常到达
    
如果 ActualArrivalTime > TimeoutThreshold:
    状态 = 超时到达（可能发生拥堵或设备故障）
    
如果 超过 TimeoutThreshold 仍未到达:
    状态 = 包裹丢失（需要人工介入）
```

### 3.3 异常场景处理

#### 提前落格
- **原因**: 包裹与前包裹距离过近，摆轮切换不及时
- **检测**: 实际到达时间 < 理论时间 * 0.8
- **处理**: 记录异常日志，上报告警

#### 擦肩（Miss）
- **原因**: 包裹通过摆轮时，摆轮方向未切换到位
- **检测**: 包裹未在预期格口检测到，但在后续格口检测到
- **处理**: 路径重规划或路由到异常格口

#### 超时
- **原因**: 设备故障、皮带速度下降、拥堵
- **检测**: 实际到达时间 > 超时阈值
- **处理**: 上报告警，触发背压控制

#### 丢失
- **原因**: 包裹卡住、掉落、传感器故障
- **检测**: 超过超时阈值后仍未检测到
- **处理**: 触发人工介入流程

## 四、使用 API

### 4.1 配置线体拓扑

```http
PUT /api/config/line-topology
Content-Type: application/json

{
  "topologyName": "标准线体拓扑",
  "wheelNodes": [...],
  "chutes": [...],
  "lineSegments": [...],
  "defaultLineSpeedMmps": 1000.0
}
```

### 4.2 查询线体拓扑

```http
GET /api/config/line-topology
```

返回完整的线体拓扑配置，包括所有节点、格口和线体段信息。

### 4.3 配置摆轮硬件绑定

```http
PUT /api/config/wheel-bindings
Content-Type: application/json

{
  "bindings": [
    {
      "wheelNodeId": "WHEEL-1",
      "wheelName": "第一摆轮",
      "driverId": 1,
      "ioAddress": "192.168.1.100",
      "ioChannel": 1
    }
  ]
}
```

## 五、代码示例

### 5.1 估算到达时间

```csharp
var estimator = serviceProvider.GetRequiredService<IRouteTimingEstimator>();

// 使用标称速度估算
var estimate = estimator.EstimateArrivalTime("CHUTE-001");

Console.WriteLine($"格口: {estimate.ChuteId}");
Console.WriteLine($"总距离: {estimate.TotalDistanceMm} mm");
Console.WriteLine($"预计到达时间: {estimate.EstimatedArrivalTimeMs} ms");
Console.WriteLine($"使用速度: {estimate.SpeedMmPerSec} mm/s");

// 使用自定义速度估算
var customEstimate = estimator.EstimateArrivalTime("CHUTE-001", speedMmPerSec: 800.0);
```

### 5.2 计算超时阈值

```csharp
var estimator = serviceProvider.GetRequiredService<IRouteTimingEstimator>();

// 使用默认容忍系数（1.5）
var timeout = estimator.CalculateTimeoutThreshold("CHUTE-001");

// 使用自定义容忍系数
var customTimeout = estimator.CalculateTimeoutThreshold("CHUTE-001", toleranceFactor: 2.0);

Console.WriteLine($"格口 CHUTE-001 的超时阈值: {timeout} ms");
```

### 5.3 路径查询和验证

```csharp
var topology = _topologyRepository.Get();

// 查询路径
var path = topology.GetPathToChute("CHUTE-003");
if (path == null)
{
    Console.WriteLine("无法找到到该格口的路径");
    return;
}

// 计算总距离
var totalDistance = topology.CalculateTotalDistance("CHUTE-003");
Console.WriteLine($"到 CHUTE-003 的总距离: {totalDistance} mm");

// 遍历路径段
foreach (var segment in path)
{
    Console.WriteLine($"段: {segment.FromNodeId} -> {segment.ToNodeId}");
    Console.WriteLine($"  长度: {segment.LengthMm} mm");
    Console.WriteLine($"  速度: {segment.NominalSpeedMmPerSec} mm/s");
    Console.WriteLine($"  预计时间: {segment.CalculateTransitTimeMs()} ms");
}
```

## 六、最佳实践

### 6.1 配置建议

1. **线体段长度**: 使用实际测量值，精确到毫米
2. **标称速度**: 使用稳定运行时的平均速度
3. **落格偏移**: 根据实际格口位置调整，通常在 300-1000mm 范围
4. **容忍系数**: 根据线体负载情况动态调整

### 6.2 监控建议

1. **实时监控**: 监控每个格口的实际到达时间与理论时间的偏差
2. **异常告警**: 当偏差超过 20% 时触发告警
3. **性能分析**: 定期分析超时和提前到达的比例，优化配置

### 6.3 调试建议

1. **从简单到复杂**: 先配置简单拓扑（1-2个摆轮），验证通过后再扩展
2. **逐段验证**: 配置完一个线体段后，立即测试该段的时间估算准确性
3. **使用仿真**: 利用仿真模式测试不同配置的效果

## 七、常见问题

### Q1: 如何处理多速度段？

A: 为每个线体段配置独立的速度值，系统会自动根据各段速度计算总时间。

```json
{
  "lineSegments": [
    {
      "segmentId": "FAST-SECTION",
      "lengthMm": 5000.0,
      "nominalSpeedMmPerSec": 1200.0
    },
    {
      "segmentId": "SLOW-SECTION",
      "lengthMm": 3000.0,
      "nominalSpeedMmPerSec": 800.0
    }
  ]
}
```

### Q2: 如何配置异常格口？

A: 在格口配置中设置 `isExceptionChute: true`，该格口将用于接收无法正常分拣的包裹。

```json
{
  "chuteId": "CHUTE-999",
  "chuteName": "异常格口",
  "isExceptionChute": true,
  "boundNodeId": "WHEEL-3",
  "boundDirection": "Straight"
}
```

### Q3: 如何调整超时阈值？

A: 通过调用 `CalculateTimeoutThreshold` 方法时传入不同的容忍系数：

```csharp
// 宽松模式（调试、测试）
var timeout = estimator.CalculateTimeoutThreshold("CHUTE-001", toleranceFactor: 2.0);

// 严格模式（生产环境）
var timeout = estimator.CalculateTimeoutThreshold("CHUTE-001", toleranceFactor: 1.3);
```

## 八、版本历史

- **v1.0** (2025-11-22): 初始版本，支持基本的线体拓扑建模和时间计算

---

**文档维护**: ZakYip Development Team  
**更新日期**: 2025-11-22
