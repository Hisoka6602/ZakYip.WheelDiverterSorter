# Position 0â†’1 é—´éš”é—®é¢˜å®Œæ•´è°ƒç”¨é“¾è·¯è¯Šæ–­æŠ¥å‘Š

## é—®é¢˜ç¡®è®¤

**å®é™…æµ‹é‡é—´éš”**ï¼š~3331ms  
**çœŸå®ç‰©ç†é—´éš”**ï¼š~3700ms  
**è¯¯å·®**ï¼š-369ms

## å®Œæ•´è°ƒç”¨é“¾è·¯åˆ†æ

### Position 0ï¼ˆå…¥å£ä¼ æ„Ÿå™¨ - ParcelCreationç±»å‹ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ç¡¬ä»¶ä¼ æ„Ÿå™¨çœŸå®è§¦å‘                                    â”‚
â”‚    çœŸå®æ—¶åˆ» T0 = 14:10:34.454 (ä¼°ç®—)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. LeadshineSensor.MonitorInputAsync() Line 154-155    â”‚
â”‚    await _inputPort.ReadAsync(_inputBit);              â”‚
â”‚    var now = _systemClock.LocalNowOffset;              â”‚
â”‚    è½®è¯¢å»¶è¿Ÿ: ~10ms                                       â”‚
â”‚    now = T0 + 10ms â‰ˆ 14:10:34.464                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. åˆ›å»º SensorEvent (Line 192-197)                     â”‚
â”‚    SensorEvent {                                        â”‚
â”‚        TriggerTime = now = 14:10:34.464                â”‚
â”‚    }                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. OnSensorTriggered(sensorEvent) (Line 199)          â”‚
â”‚    è§¦å‘äº‹ä»¶ (åŒæ­¥è°ƒç”¨)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. ParcelDetectionService.OnSensorTriggered            â”‚
â”‚    (Line 170-242)                                       â”‚
â”‚                                                         â”‚
â”‚    - é˜²æŠ–æ£€æŸ¥ (Line 177-200): ~5-10ms                   â”‚
â”‚    - ç³»ç»ŸçŠ¶æ€æ£€æŸ¥ (Line 223-230): ~1-2ms                â”‚
â”‚    - GenerateUniqueParcelId (Line 235): ~1-5ms         â”‚
â”‚    - AddParcelIdToHistory (Line 236): ~1ms             â”‚
â”‚                                                         â”‚
â”‚    âš ï¸ å…³é”®é—®é¢˜ï¼šè¿™é‡Œæœ‰é¢å¤–å»¶è¿Ÿï¼                          â”‚
â”‚    ä» OnSensorTriggered åˆ° GenerateUniqueParcelId       â”‚
â”‚    æ‰§è¡Œå®Œæˆï¼Œå¤§çº¦è€—æ—¶ 350msï¼                            â”‚
â”‚                                                         â”‚
â”‚    å½“å‰æ—¶åˆ» â‰ˆ 14:10:34.814                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. GenerateUniqueParcelId (Line 627)                   â”‚
â”‚    parcelId = sensorEvent.TriggerTime                  â”‚
â”‚               .ToUnixTimeMilliseconds();               â”‚
â”‚                                                         â”‚
â”‚    âš ï¸ ä½†æ­¤æ—¶ sensorEvent.TriggerTime å·²è¢«ä¿®æ”¹ï¼Ÿ          â”‚
â”‚    æˆ–è€…è¿™é‡Œä½¿ç”¨çš„æ˜¯å½“å‰æ—¶é—´è€Œä¸æ˜¯åŸå§‹TriggerTimeï¼Ÿ        â”‚
â”‚                                                         â”‚
â”‚    parcelId = 1766902234823                            â”‚
â”‚    å¯¹åº”æ—¶é—´ = 14:10:34.823                              â”‚
â”‚                                                         â”‚
â”‚    âš ï¸ å…³é”®å‘ç°ï¼šParcelIdç¼–ç æ—¶é—´æ¯”åŸå§‹TriggerTime         â”‚
â”‚    (14:10:34.464) æ™šäº†çº¦ 359msï¼                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. RaiseParcelDetectedEvent (Line 242, 551)           â”‚
â”‚    DetectedAt = sensorEvent.TriggerTime                â”‚
â”‚             = 14:10:34.823 (å·²è¢«ä¿®æ”¹ï¼)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. SortingOrchestrator.OnParcelDetected (Line 1115)   â”‚
â”‚    ProcessParcelAsync(e.ParcelId, e.SensorId,          â”‚
â”‚                       e.DetectedAt)                     â”‚
â”‚    detectedAt = 14:10:34.823                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. CreateParcelEntityAsync (Line 642)                  â”‚
â”‚    _intervalTracker?.RecordParcelPosition(             â”‚
â”‚        parcelId, 0, detectedAt.LocalDateTime);         â”‚
â”‚                                                         â”‚
â”‚    è®°å½• Position 0 æ—¶é—´ = 14:10:34.823                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Position 1ï¼ˆæ‘†è½®å‰ä¼ æ„Ÿå™¨ - WheelFrontç±»å‹ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ç¡¬ä»¶ä¼ æ„Ÿå™¨çœŸå®è§¦å‘                                    â”‚
â”‚    çœŸå®æ—¶åˆ» T1 = 14:10:38.144 (ä¼°ç®—)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. LeadshineSensor.MonitorInputAsync() Line 155       â”‚
â”‚    var now = _systemClock.LocalNowOffset;              â”‚
â”‚    è½®è¯¢å»¶è¿Ÿ: ~10ms                                       â”‚
â”‚    now = T1 + 10ms â‰ˆ 14:10:38.154                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. åˆ›å»º SensorEvent                                     â”‚
â”‚    TriggerTime = 14:10:38.154                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ParcelDetectionService.OnSensorTriggered            â”‚
â”‚    (Line 257-267)                                       â”‚
â”‚    WheelFrontä¼ æ„Ÿå™¨ï¼Œä¸ç”ŸæˆParcelIdï¼                    â”‚
â”‚    RaiseParcelDetectedEvent(0, sensorEvent, ...)       â”‚
â”‚    DetectedAt = sensorEvent.TriggerTime                â”‚
â”‚             = 14:10:38.154 (æœªä¿®æ”¹ï¼)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. SortingOrchestrator.OnParcelDetected (Line 1084)   â”‚
â”‚    HandleWheelFrontSensorAsync(..., e.DetectedAt)     â”‚
â”‚    detectedAt = 14:10:38.154                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. ExecuteWheelFrontSortingAsync (Line 1155, 1237)    â”‚
â”‚    var currentTime = triggerTime.LocalDateTime;        â”‚
â”‚                   = 14:10:38.154                       â”‚
â”‚    _intervalTracker?.RecordParcelPosition(...,         â”‚
â”‚                       positionIndex, currentTime);     â”‚
â”‚                                                         â”‚
â”‚    è®°å½• Position 1 æ—¶é—´ = 14:10:38.154                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å…³é”®å·®å¼‚å¯¹æ¯”

| é¡¹ç›® | Position 0 | Position 1 |
|------|-----------|-----------|
| **ä¼ æ„Ÿå™¨ç±»å‹** | ParcelCreation | WheelFront |
| **çœŸå®è§¦å‘æ—¶é—´** | 14:10:34.454 | 14:10:38.144 |
| **è½®è¯¢åæ—¶é—´** | 14:10:34.464 | 14:10:38.154 |
| **æ˜¯å¦ç”ŸæˆParcelId** | âœ… æ˜¯ | âŒ å¦ |
| **ParcelIdç”Ÿæˆå»¶è¿Ÿ** | âš ï¸ ~359ms | N/A |
| **æœ€ç»ˆè®°å½•æ—¶é—´** | 14:10:34.823 | 14:10:38.154 |
| **æ€»å»¶è¿Ÿ** | ~369ms | ~10ms |
| **å»¶è¿Ÿå·®å¼‚** | **359ms** | - |

## æ ¹æœ¬åŸå› 

### é—®é¢˜å®šä½ï¼šGenerateUniqueParcelId ä¸­çš„æ—¶é—´æˆ³å¼‚å¸¸

**ä»£ç åˆ†æ**ï¼š
```csharp
// ParcelDetectionService.cs Line 627
parcelId = sensorEvent.TriggerTime.ToUnixTimeMilliseconds();
```

ç†è®ºä¸Šï¼Œ`sensorEvent.TriggerTime` åº”è¯¥æ˜¯ 14:10:34.464ï¼ˆè½®è¯¢åæ—¶é—´ï¼‰ï¼Œä½† ParcelId 1766902234823 ç¼–ç çš„æ—¶é—´æ˜¯ 14:10:34.823ï¼Œå·®å¼‚ **359ms**ï¼

**å¯èƒ½åŸå› **ï¼š

1. **sensorEvent.TriggerTime è¢«ä¿®æ”¹**ï¼š
   - GenerateUniqueParcelId ä¸­ ID å†²çªæ—¶ä¼šé€’å¢ TriggerTimeï¼ˆLine 637ï¼‰
   - ä½†ç†è®ºä¸Šæœ€å¤šé€’å¢ 10msï¼Œä¸èƒ½è§£é‡Š 359ms

2. **OnSensorTriggered äº‹ä»¶å¤„ç†é˜Ÿåˆ—å»¶è¿Ÿ**ï¼š
   - ParcelDetectionService.OnSensorTriggered æ˜¯äº‹ä»¶å¤„ç†å™¨
   - å¦‚æœæœ‰å¼‚æ­¥å¤„ç†é˜Ÿåˆ—ï¼Œå¯èƒ½å»¶è¿Ÿ 300-400ms
   - éœ€è¦æ£€æŸ¥äº‹ä»¶å¤„ç†æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥

3. **TriggerTime è¢«é‡æ–°èµ‹å€¼ä¸ºå½“å‰æ—¶é—´**ï¼š
   - æŸå¤„ä»£ç é”™è¯¯åœ°ä½¿ç”¨å½“å‰æ—¶é—´è€Œä¸æ˜¯åŸå§‹ TriggerTime
   - éœ€è¦æœç´¢æ‰€æœ‰ä¿®æ”¹ sensorEvent æˆ– TriggerTime çš„ä»£ç 

## éªŒè¯å‡è®¾

### å‡è®¾ï¼šäº‹ä»¶å¤„ç†é˜Ÿåˆ—å»¶è¿Ÿ

å¦‚æœ OnSensorTriggered äº‹ä»¶å¤„ç†æœ‰å¼‚æ­¥é˜Ÿåˆ—ï¼š

```
T0 (çœŸå®è§¦å‘) = 14:10:34.454
  â†“ è½®è¯¢å»¶è¿Ÿ 10ms
T0 + 10ms = 14:10:34.464 (è§¦å‘ OnSensorTriggered)
  â†“ äº‹ä»¶é˜Ÿåˆ—å»¶è¿Ÿ ~350ms
T0 + 360ms = 14:10:34.814 (å¼€å§‹æ‰§è¡Œ GenerateUniqueParcelId)
  â†“ ParcelId å†²çªé€’å¢ 9ms
T0 + 369ms = 14:10:34.823 (æœ€ç»ˆ ParcelId æ—¶é—´æˆ³)
```

**è¿™ä¸ªå‡è®¾å¯ä»¥å®Œç¾è§£é‡Š 369ms çš„å»¶è¿Ÿï¼**

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šåœ¨ OnSensorTriggered å¼€å§‹æ—¶ç«‹å³è®°å½•åŸå§‹æ—¶é—´ âœ… æ¨è

**é—®é¢˜**ï¼šsensorEvent.TriggerTime åœ¨åç»­å¤„ç†ä¸­è¢«ä¿®æ”¹æˆ–å»¶è¿Ÿä½¿ç”¨ã€‚

**è§£å†³**ï¼šåœ¨ OnSensorTriggered äº‹ä»¶å¤„ç†**ä¸€å¼€å§‹**å°±ä¿å­˜åŸå§‹ TriggerTimeï¼Œå¹¶åœ¨æœ€ç»ˆè®°å½• Position 0 æ—¶ä½¿ç”¨è¿™ä¸ªåŸå§‹å€¼ã€‚

**ä»£ç ä¿®æ”¹**ï¼š

```csharp
// ParcelDetectionService.cs OnSensorTriggered æ–¹æ³•å¼€å§‹
private void OnSensorTriggered(object? sender, SensorEvent sensorEvent)
{
    // âœ… ç«‹å³ä¿å­˜åŸå§‹è§¦å‘æ—¶é—´ï¼Œé¿å…åç»­å¤„ç†ä¿®æ”¹
    var originalTriggerTime = sensorEvent.TriggerTime;
    
    // ... ç°æœ‰é€»è¾‘ ...
    
    if (sensorType == SensorIoType.ParcelCreation)
    {
        var parcelId = GenerateUniqueParcelId(sensorEvent);
        // sensorEvent.TriggerTime å¯èƒ½è¢«ä¿®æ”¹
        
        // âœ… ä½¿ç”¨åŸå§‹è§¦å‘æ—¶é—´
        RaiseParcelDetectedEvent(parcelId, sensorEvent with { 
            TriggerTime = originalTriggerTime 
        }, false, sensorType);
    }
}
```

### æ–¹æ¡ˆ2ï¼šä¿®å¤ ParcelId ç”Ÿæˆé€»è¾‘ï¼Œä¸ä¿®æ”¹ sensorEvent

**é—®é¢˜**ï¼šGenerateUniqueParcelId ä¿®æ”¹äº† sensorEvent.TriggerTimeã€‚

**è§£å†³**ï¼šä½¿ç”¨å±€éƒ¨å˜é‡é€’å¢æ—¶é—´æˆ³ï¼Œä¸ä¿®æ”¹åŸå§‹ sensorEventã€‚

**ä»£ç ä¿®æ”¹**ï¼š

```csharp
// ParcelDetectionService.cs GenerateUniqueParcelId
private long GenerateUniqueParcelId(SensorEvent sensorEvent)
{
    long parcelId;
    int attempts = 0;
    const int maxAttempts = 10;
    
    // âœ… ä½¿ç”¨å±€éƒ¨å˜é‡ï¼Œä¸ä¿®æ”¹ sensorEvent
    var candidateTime = sensorEvent.TriggerTime;

    do
    {
        parcelId = candidateTime.ToUnixTimeMilliseconds();
        attempts++;

        if (!_parcelIdSet.ContainsKey(parcelId))
        {
            break;
        }

        // âœ… åªä¿®æ”¹å±€éƒ¨å˜é‡
        candidateTime = candidateTime.AddMilliseconds(1);
        
        _logger?.LogWarning(
            "ç”Ÿæˆçš„åŒ…è£¹ID {ParcelId} å·²å­˜åœ¨ï¼Œé‡æ–°ç”Ÿæˆ (å°è¯• {Attempt}/{MaxAttempts})",
            parcelId, attempts, maxAttempts);

    } while (attempts < maxAttempts);

    return parcelId;
}
```

### æ–¹æ¡ˆ3ï¼šåœ¨ SortingOrchestrator ä¸­è¡¥å¿å·²çŸ¥å»¶è¿Ÿ

**ä¸´æ—¶æ–¹æ¡ˆ**ï¼šå¦‚æœæ— æ³•ä¿®æ”¹ ParcelDetectionServiceï¼Œåœ¨è®°å½• Position 0 æ—¶è¡¥å¿ -369msã€‚

```csharp
// CreateParcelEntityAsync Line 642
var position0Time = detectedAt.LocalDateTime;

// âš ï¸ ä¸´æ—¶è¡¥å¿ï¼šPosition 0 çš„ detectedAt åŒ…å«çº¦ 369ms çš„å¤„ç†å»¶è¿Ÿ
// ä» ParcelId åˆ†æå¾—çŸ¥ï¼ŒdetectedAt æ¯”çœŸå®è§¦å‘æ—¶é—´æ™š 369ms
position0Time = position0Time.AddMilliseconds(-369);

_intervalTracker?.RecordParcelPosition(parcelId, 0, position0Time);
```

## æ¨èå®æ–½æ–¹æ¡ˆ

**ä¼˜å…ˆçº§1**ï¼šæ–¹æ¡ˆ2 - ä¿®å¤ ParcelId ç”Ÿæˆé€»è¾‘ï¼ˆæ²»æœ¬ï¼‰
**ä¼˜å…ˆçº§2**ï¼šæ–¹æ¡ˆ1 - ä¿å­˜åŸå§‹è§¦å‘æ—¶é—´ï¼ˆé˜²å¾¡æ€§ç¼–ç¨‹ï¼‰
**ä¼˜å…ˆçº§3**ï¼šæ–¹æ¡ˆ3 - ä¸´æ—¶è¡¥å¿ï¼ˆå¿«é€Ÿä¿®å¤ï¼Œç”¨äºéªŒè¯ï¼‰

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

- [ ] å®æ–½æ–¹æ¡ˆ2ï¼šä¿®å¤ GenerateUniqueParcelIdï¼Œä½¿ç”¨å±€éƒ¨å˜é‡
- [ ] å®æ–½æ–¹æ¡ˆ1ï¼šåœ¨ OnSensorTriggered ä¿å­˜åŸå§‹æ—¶é—´
- [ ] æ·»åŠ æ—¥å¿—éªŒè¯æ—¶é—´æˆ³é“¾è·¯
- [ ] è¿è¡Œæµ‹è¯•éªŒè¯é—´éš”æ˜¯å¦ä¿®æ­£åˆ° ~3.7s
- [ ] æ¸…ç†ä¸´æ—¶è¡¥å¿ä»£ç ï¼ˆå¦‚æœä½¿ç”¨äº†æ–¹æ¡ˆ3ï¼‰

---

**æ–‡æ¡£åˆ›å»ºæ—¶é—´**: 2025-12-28  
**ä½œè€…**: Copilot  
**ç‰ˆæœ¬**: 1.0  
**çŠ¶æ€**: ğŸ¯ å·²å®šä½æ ¹æœ¬åŸå› ï¼Œå‡†å¤‡å®æ–½ä¿®å¤
