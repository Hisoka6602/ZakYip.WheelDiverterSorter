# ZakYip.WheelDiverterSorter

直线摆轮分拣系统

## ⚠️ 重要说明

本程序和 [ZakYip.Sorting.RuleEngine.Core](https://github.com/Hisoka6602/ZakYip.Sorting.RuleEngine.Core) 是**分开部署**的两个独立程序，互为上下游关系：

- **ZakYip.WheelDiverterSorter（本项目，下游）**：
  - 通过**IO传感器**感应物理包裹并创建包裹记录
  - 向RuleEngine请求格口号
  - 负责**实际执行分拣**动作（控制摆轮）

- **ZakYip.Sorting.RuleEngine.Core（上游）**：
  - 接收包裹ID请求
  - 与**DWS第三方API**通信获取包裹信息（条码、重量、尺寸等）
  - 通过规则引擎决策目标格口号
  - 返回格口号给WheelDiverterSorter

**通信方式：** 两个系统通过**TCP/SignalR/MQTT**等协议通信（多选一）
- ✅ **生产环境推荐**：TCP、SignalR或MQTT（高性能、长连接）
- ❌ **生产环境禁止**：HTTP（仅用于模拟测试，性能不足）

详细的系统关系和集成方案请参阅：[与规则引擎的关系文档](RELATIONSHIP_WITH_RULEENGINE.md)

---

## 项目简介

本项目是一个基于直线摆轮（Wheel Diverter）的包裹自动分拣系统。通过在直线输送线上配置多个摆轮节点，实现包裹到不同格口的智能分拣。系统采用分层架构设计，支持路径规划、执行和可观测性。

---

## 📋 最近更新内容（2025-11-12）

### ✅ 新增功能

#### 1. 系统配置管理增强 🆕
- **LiteDB配置存储**：所有系统级配置存储在LiteDB数据库中，支持环境迁移
- **热重载支持**：配置更新后立即生效，无需重启服务
- **完整的REST API**：
  - `GET /api/config/system` - 获取当前系统配置
  - `PUT /api/config/system` - 更新系统配置（热重载）
  - `GET /api/config/system/template` - 获取默认配置模板
  - `POST /api/config/system/reset` - 重置为默认配置
- **配置验证**：自动验证所有参数的有效性（端口范围、超时时间等）
- **版本控制**：每次更新自动递增版本号，便于追踪变更
- **灵活的配置项**：
  - 异常格口ID（不再硬编码）
  - MQTT/TCP默认端口
  - 格口分配超时时间
  - 请求超时、重试次数和延迟
  - 自动重连开关

详细配置管理指南请参阅：[系统配置管理指南](SYSTEM_CONFIG_GUIDE.md)

#### 2. API文档系统集成 🆕
- **Swagger/OpenAPI文档**：集成Swashbuckle.AspNetCore，提供交互式API文档
- **中文界面支持**：API文档使用中文标题和描述，便于国内开发者使用
- **XML注释文档**：所有控制器和模型都包含详细的XML文档注释
- **示例值展示**：请求和响应模型包含示例数据，方便理解
- **Postman集合**：提供预配置的Postman collection，可直接导入测试
- **API使用教程**：完整的中文使用指南，包含示例和最佳实践

访问Swagger UI：启动服务后访问 `http://localhost:5000/swagger`

详细API使用教程请参阅：[API使用教程](API_USAGE_GUIDE.md)

#### 3. 传感器健康监控系统（Ingress层增强） 🆕
- **新增健康监控服务**：`ISensorHealthMonitor` 接口和 `SensorHealthMonitor` 实现
- **传感器状态监控**：实时监控所有传感器的健康状态
- **故障检测机制**：
  - 自动检测连续错误（默认阈值3次）
  - 检测长时间无响应（可配置超时时间）
  - 故障类型分类（通信超时、读取错误、设备离线等）
- **故障告警**：通过事件通知传感器故障和恢复
- **健康统计**：记录触发次数、错误次数、运行时长等指标
- **错误事件系统**：传感器错误自动报告给健康监控服务

#### 3. 传感器健康监控系统（Ingress层增强） 🆕
- **新增健康监控服务**：`ISensorHealthMonitor` 接口和 `SensorHealthMonitor` 实现
- **传感器状态监控**：实时监控所有传感器的健康状态
- **故障检测机制**：
  - 自动检测连续错误（默认阈值3次）
  - 检测长时间无响应（可配置超时时间）
  - 故障类型分类（通信超时、读取错误、设备离线等）
- **故障告警**：通过事件通知传感器故障和恢复
- **健康统计**：记录触发次数、错误次数、运行时长等指标
- **错误事件系统**：传感器错误自动报告给健康监控服务

#### 4. 传感器错误处理增强 🆕
- **新增错误事件**：`ISensor` 接口添加 `SensorError` 事件
- **实时错误报告**：Leadshine传感器自动报告读取错误
- **错误传播**：错误事件从传感器 → 包裹检测服务 → 健康监控服务
- **错误恢复机制**：传感器正常触发后自动重置错误计数

#### 5. 传感器驱动完善
- **雷赛驱动已实现**：
  - ✅ 光电传感器驱动 (`LeadshinePhotoelectricSensor`)
  - ✅ 激光传感器驱动 (`LeadshineLaserSensor`)
  - ✅ 传感器工厂 (`LeadshineSensorFactory`)
- **松耦合架构**：通过工厂模式支持多厂商扩展
- **配置驱动**：通过 `appsettings.json` 切换传感器厂商

#### 5. 硬件驱动支持（Drivers层）
- **新增硬件驱动层**：`ZakYip.WheelDiverterSorter.Drivers` 项目
- **雷赛控制器集成**：实现了基于雷赛（Leadshine）LTDMC系列运动控制卡的摆轮控制
- **IO端口抽象**：定义了标准的输入/输出端口接口（`IInputPort`、`IOutputPort`）
- **摆轮控制器接口**：定义了`IDiverterController`接口，支持角度控制和状态反馈
- **硬件路径执行器**：实现了`HardwareSwitchingPathExecutor`，替代模拟执行器用于真实设备控制
- **可切换架构**：支持通过配置在模拟驱动器和硬件驱动器之间切换（`UseHardwareDriver`配置项）
- **参考实现**：参考了[ZakYip.Singulation](https://github.com/Hisoka6602/ZakYip.Singulation)项目的IO厂商和读写逻辑

#### 6. 配置增强
- **驱动器配置**：新增`DriverOptions`配置类，支持硬件参数配置
- **雷赛配置**：支持配置卡号、摆轮映射、IO端口等参数
- **热切换**：可通过修改配置文件切换模拟/硬件模式，无需修改代码

#### 7. 文档完善
- **硬件驱动文档**：新增`Drivers/README.md`，详细说明硬件集成方式
- **雷赛驱动文档**：新增`Drivers/Leadshine/README.md`，说明雷赛控制器集成细节
- **配置示例**：提供完整的硬件配置示例和故障排查指南
- **API使用教程**：新增`API_USAGE_GUIDE.md`，提供完整API接口使用指南
- **Postman集合**：提供`postman_collection.json`，可直接导入Postman测试

### 🔄 重要变更

- **传感器架构升级**：从仅有模拟传感器升级到支持真实硬件传感器
- **健康监控集成**：传感器服务自动集成健康监控，无需手动配置
- **错误处理完善**：增强了传感器层的错误检测和报告机制
- **依赖注入优化**：通过 `AddSensorServices()` 扩展方法自动注册所有服务
- **执行器架构升级**：从单一模拟执行器扩展到支持真实硬件执行器
- **依赖注入优化**：通过`DriverServiceExtensions`自动注册驱动服务
- **错误处理增强**：硬件执行器捕获设备异常并转换为执行结果

### 📊 影响范围

- **增强项目**：`ZakYip.WheelDiverterSorter.Ingress`
  - 新增 `ISensorHealthMonitor` 接口和实现
  - 新增 `SensorHealthStatus`、`SensorFaultEventArgs`、`SensorRecoveryEventArgs` 等模型
  - 新增 `SensorErrorEventArgs` 模型
  - 增强 `ISensor` 接口（添加 `SensorError` 事件）
  - 增强 `ParcelDetectionService`（集成健康监控）
  - 增强 `SensorServiceExtensions`（自动注册健康监控服务）
- **新增项目**：`ZakYip.WheelDiverterSorter.Drivers`
- **修改配置**：`appsettings.json`需添加`Driver`配置节
- **服务注册**：`Program.cs`需调用`AddDriverServices()`
- **部署要求**：生产环境需要雷赛LTDMC.dll及驱动程序

---

## 项目当前完成度

### ✅ 已完成功能

- **核心路径生成逻辑** (100%)
  - 实现了基于格口到摆轮映射的路径生成器 (`DefaultSwitchingPathGenerator`)
  - 支持多段摆轮路径生成，每段包含摆轮ID、目标角度和TTL
  - 定义了完整的拓扑结构模型 (`SorterTopology`, `DiverterNode`)
  - 支持基于LiteDB的动态配置管理和热更新

- **执行器层** (100%)
  - ✅ 实现了模拟执行器 (`MockSwitchingPathExecutor`)
  - ✅ **新增**：实现了硬件执行器 (`HardwareSwitchingPathExecutor`)
  - 支持异步执行和取消操作
  - 包含完整的错误处理和异常格口回退机制
  - 支持通过配置切换模拟/硬件模式

- **硬件驱动层** (80%) 🆕
  - ✅ **新增**：完整的Drivers层架构 (`ZakYip.WheelDiverterSorter.Drivers`)
  - ✅ IO端口抽象接口 (`IInputPort`, `IOutputPort`)
  - ✅ 摆轮控制器接口 (`IDiverterController`)
  - ✅ 雷赛（Leadshine）控制器实现
  - ✅ 硬件配置管理 (`DriverOptions`, `LeadshineOptions`)
  - ✅ 驱动服务注册扩展 (`DriverServiceExtensions`)
  - ⚠️ 仅支持雷赛控制器，其他厂商待扩展

- **调试Web接口** (100%)
  - 提供HTTP API端点用于手动触发分拣测试 (`POST /api/debug/sort`)
  - 包含完整的请求验证和响应模型
  - 集成了日志注入防护

- **配置管理系统** (100%)
  - ✅ 基于LiteDB的配置存储
  - ✅ 完整的RESTful API用于配置管理
  - ✅ 支持热更新，配置变更立即生效
  - ✅ 配置验证和完整性检查
  - 详见 [配置管理API文档](CONFIGURATION_API.md)

- **基础架构** (100%)
  - 采用依赖注入（DI）设计模式
  - 定义了清晰的接口抽象（`ISwitchingPathGenerator`, `ISwitchingPathExecutor`）
  - 支持ASP.NET Core Minimal API
  - 完整的依赖服务注册机制

### 🚧 部分完成功能

- **入口管理** (85%) 🔄 🆕
  - ✅ 已创建Ingress层完整架构
  - ✅ 定义了传感器接口 (`ISensor`)
  - ✅ 实现了模拟传感器（光电、激光）
  - ✅ **新增**：实现了雷赛真实传感器驱动（光电、激光）
  - ✅ **新增**：实现了传感器工厂模式 (`ISensorFactory`)
  - ✅ **新增**：实现了传感器健康监控服务 (`ISensorHealthMonitor`)
  - ✅ **新增**：实现了传感器错误检测和报告机制
  - ✅ 实现了包裹检测服务 (`ParcelDetectionService`)
  - ✅ 支持通过配置切换模拟/真实传感器
  - ⚠️ 缺少扫码触发和供包台触发等生产环境入口

- **可观测性** (30%)
  - 项目结构中已创建Observability层，但功能未实现
  - 当前仅有基础日志记录，缺少指标收集、链路追踪等
  - 需要集成Prometheus、Grafana、OpenTelemetry

- **通信层** (100%) ✅ **已完成** 🆕
  - ✅ 实现了TCP/SignalR/MQTT/HTTP客户端
  - ✅ 完整的连接管理和自动重连机制
  - ✅ 错误处理和重试逻辑
  - ✅ 与包裹检测流程集成
  - ✅ ParcelSortingOrchestrator编排服务
  - 详见 [通信层集成文档](COMMUNICATION_INTEGRATION.md)

### ❌ 未完成功能

- **真实IO传感器集成** ✅ **已完成**
  - ~~需要集成真实物理传感器硬件（光电、激光等）~~
  - ~~当前仅有模拟传感器实现~~
  - ~~需要实现传感器驱动的工厂模式~~
  - ✅ 雷赛传感器驱动已完成
  - ✅ 传感器健康监控已完成
  - ⚠️ 其他厂商传感器待扩展

- **与RuleEngine通信** ✅ **已完成** 🆕
  - ~~实现TCP/SignalR/MQTT客户端~~
  - ~~向RuleEngine请求格口号~~
  - ~~处理连接管理和错误重试~~
  - ✅ 全部通信功能已实现并集成
  - 详见 [通信层集成文档](COMMUNICATION_INTEGRATION.md)

- **多厂商硬件支持**
  - 当前仅支持雷赛（Leadshine）控制器
  - 需要扩展支持其他PLC厂商（西门子、三菱、欧姆龙等）
  - 需要实现控制器驱动的插件化架构

- **高级路径算法**
  - 当前使用直接映射，不支持动态路径优化
  - 不支持基于拓扑图的自动路径搜索
  - 缺少负载均衡和路径重规划功能

- **生产环境功能**
  - 无扫码触发集成
  - 无供包台接口
  - 缺少包裹跟踪和历史记录
  - 缺少异常告警机制
  - 缺少设备状态监控仪表板

- **测试覆盖**
  - 项目中无单元测试或集成测试
  - 缺少硬件驱动的集成测试
  - 缺少性能测试和压力测试

### 📊 完成度总结

| 模块 | 完成度 | 状态 | 说明 |
|-----|--------|------|------|
| 核心路径生成 | 100% | ✅ | 完全可用 |
| 配置管理系统 | 100% | ✅ | 支持热更新 |
| 模拟执行器 | 100% | ✅ | 开发测试用 |
| 硬件执行器 | 100% | ✅ 🆕 | 生产环境可用 |
| 硬件驱动层 | 80% | 🚧 🆕 | 雷赛已支持，需扩展其他厂商 |
| 入口管理 | 85% | 🚧 🆕 | 真实传感器完成，健康监控完成 |
| 传感器驱动 | 85% | ✅ 🆕 | 雷赛驱动完成，健康监控完成 |
| 调试接口 | 100% | ✅ | 测试环境可用 |
| 可观测性 | 30% | ⚠️ | 仅基础日志 |
| 通信层 | 100% | ✅ 🆕 | TCP/SignalR/MQTT/HTTP全部实现并集成 |
| 测试覆盖 | 0% | ❌ | 无测试 |

**整体完成度：约 85%**（相比之前的80%有所提升，通信层已完成）

## 🎯 后续开发方向和计划

### 核心目标：实现与RuleEngine.Core的完整集成 + 真实硬件部署

为了实现完整的自动分拣流程，需要按以下优先级进行开发：

### 阶段1：真实传感器集成（高优先级） ⏰ 预计2-3周 ✅ **已完成**

**目标**：实现真实物理传感器的硬件集成

**任务清单**：
- [x] **实现真实传感器驱动**（Ingress层）
  - 集成真实光电传感器驱动（参考ZakYip.Singulation，使用雷赛IO监控）
  - 集成真实激光传感器驱动
  - 实现传感器工厂模式，支持动态加载不同厂商
  - 传感器状态监控和故障检测
  - 松耦合设计，便于后续扩展
  
- [x] **包裹创建流程增强**
  - 传感器触发时自动生成唯一包裹ID ✅
  - 记录包裹检测时间和位置 ✅
  - 包裹去重机制（防止重复触发）✅
  
- [x] **传感器健康监控** 🆕
  - 实时监控传感器状态
  - 故障检测和告警机制
  - 传感器恢复检测
  - 健康统计和指标
  
- [x] **配置管理**
  - 传感器硬件配置（端口、类型等）✅
  - 支持热切换传感器厂商 ✅
  - 通过配置文件切换模拟/真实模式 ✅

**修改涉及的文件**：
- `ZakYip.WheelDiverterSorter.Ingress/Sensors/` ✅ 已实现真实传感器
- `ZakYip.WheelDiverterSorter.Ingress/Services/` ✅ 已实现健康监控服务
- `ZakYip.WheelDiverterSorter.Ingress/Models/` ✅ 已添加健康状态模型
- `ZakYip.WheelDiverterSorter.Ingress/Configuration/` ✅ 完善传感器配置
- `appsettings.json` ✅ 支持传感器配置

**依赖**：需要真实传感器硬件设备和驱动程序（雷赛控制卡）

**状态**：✅ **已完成** - 雷赛传感器驱动已集成，健康监控已实现，松耦合架构已就位

### 阶段2：多厂商硬件驱动扩展（高优先级） ⏰ 预计2-3周

**目标**：扩展支持更多PLC厂商和控制器

**任务清单**：
- [ ] **实现西门子（Siemens）驱动**
  - S7系列PLC通信（S7-200/300/1200/1500）
  - Snap7或LibNoDave库集成
  - 西门子控制器配置管理
  
- [ ] **实现三菱（Mitsubishi）驱动**
  - FX/Q系列PLC通信
  - MC协议实现
  - 三菱控制器配置管理
  
- [ ] **实现欧姆龙（Omron）驱动**
  - CP/CJ/NJ系列PLC通信
  - FINS协议实现
  - 欧姆龙控制器配置管理
  
- [ ] **驱动插件化架构**
  - 实现驱动加载器（DriverLoader）
  - 支持通过配置动态加载驱动插件
  - 驱动版本管理和兼容性检查

**修改涉及的文件**：
- 新增 `ZakYip.WheelDiverterSorter.Drivers/Siemens/`
- 新增 `ZakYip.WheelDiverterSorter.Drivers/Mitsubishi/`
- 新增 `ZakYip.WheelDiverterSorter.Drivers/Omron/`
- `ZakYip.WheelDiverterSorter.Drivers/DriverServiceExtensions.cs` 扩展注册逻辑
- `appsettings.json` 添加多厂商配置选项

### 阶段3：通信层开发（高优先级） ⏰ 预计3-4周 ✅ **已完成** 🆕

**目标**：实现与RuleEngine.Core的网络通信

**任务清单**：
- [x] **实现多协议通信客户端**
  - TCP Socket客户端（推荐生产环境）✅
  - SignalR客户端（推荐生产环境）✅
  - MQTT客户端（推荐生产环境）✅
  - HTTP客户端（仅供测试）✅
  
- [x] **请求格口号接口**
  - 发送包裹ID到RuleEngine ✅
  - 等待接收格口号响应 ✅
  - 超时和重试机制 ✅
  - 消息序列化和反序列化 ✅
  
- [x] **连接管理**
  - 自动连接和断线重连 ✅
  - 心跳检测 ✅（SignalR自带）
  - 连接状态监控 ✅
  - 连接池管理 ✅
  
- [x] **配置切换**
  - 支持通过配置文件切换通信协议 ✅
  - 不同环境使用不同协议（测试用HTTP，生产用TCP/SignalR/MQTT）✅
  - 协议参数优化（超时、缓冲区大小等）✅

- [x] **集成到包裹分拣流程**
  - 实现ParcelSortingOrchestrator编排服务 ✅
  - 实现ParcelSortingWorker后台服务 ✅
  - 与传感器检测事件集成 ✅
  - 完整的错误处理和降级策略 ✅

**修改涉及的文件**：
- `ZakYip.WheelDiverterSorter.Communication/` ✅ 通信层项目已实现
- `ZakYip.WheelDiverterSorter.Host/Services/` ✅ 编排服务已实现
- `ZakYip.WheelDiverterSorter.Host/Program.cs` ✅ 已注册通信和编排服务
- `appsettings.json` ✅ 已添加RuleEngine连接配置
- `COMMUNICATION_INTEGRATION.md` ✅ 完整集成文档

**关键配置示例**：
```json
{
  "RuleEngineConnection": {
    "Mode": "Tcp",  // 可选: Tcp, SignalR, Mqtt, Http
    "TcpServer": "192.168.1.100:8000",
    "SignalRHub": "http://192.168.1.100:5000/sortingHub",
    "MqttBroker": "mqtt://192.168.1.100:1883",
    "HttpApi": "http://localhost:5000/api/sorting/chute",
    "TimeoutMs": 5000,
    "RetryCount": 3
  }
}
```

**状态**：✅ **已完成** - TCP/SignalR/MQTT/HTTP全部实现，并与分拣流程完整集成

### 阶段4：整合与测试（中优先级） ⏰ 预计3-4周

**目标**：将所有组件整合到完整流程并进行全面测试

**任务清单**：
- [x] **完整流程集成** ✅ 部分完成
  - 传感器检测 → 创建包裹 → 请求格口号 → 执行分拣 ✅
  - 异常处理和降级策略 ✅
  - 完整的日志记录和链路追踪 ⚠️ 仅基础日志
  - 事件驱动架构优化
  
- [ ] **硬件联调测试**
  - 真实传感器 + 真实控制器联调
  - 与RuleEngine.Core进行端到端测试
  - 模拟各种异常场景（传感器故障、控制器离线、网络中断等）
  - 边界条件测试
  
- [ ] **性能与压力测试**
  - 单包裹处理延迟测试（目标<100ms）
  - 吞吐量测试（目标500-1000包裹/分钟）
  - 并发处理测试
  - 长时间稳定性测试（24小时+）
  - 内存和CPU使用率监控
  
- [ ] **文档更新**
  - 更新部署文档（包含硬件部署步骤）
  - 编写运维手册（故障排查、日常维护）
  - API接口文档完善
  - 硬件接线图和配置指南
  - 视频教程和操作手册

### 阶段5：生产环境功能（低优先级） ⏰ 预计持续开发

**任务清单**：

- [ ] **可观测性增强**
  - 集成Prometheus指标收集
  - Grafana仪表板（分拣成功率、延迟、设备状态等）
  - OpenTelemetry链路追踪
  - ELK日志聚合和分析
  - 实时告警（钉钉/邮件/短信）

- [ ] **测试覆盖**
  - 单元测试（核心逻辑覆盖率>80%）
  - 集成测试（API端点和服务交互）
  - 硬件集成测试（Mock设备测试）
  - 性能基准测试

- [ ] **高级功能**
  - 包裹跟踪和历史记录
  - Web管理界面
  - 动态路径优化算法
  - 设备负载均衡
  - 多线路支持
  - 扫码触发集成
  - 供包台接口

### 关键修改方向总结

| 优先级 | 功能模块 | 涉及项目/文件 | 预计工期 | 依赖 | 状态 |
|-------|---------|-------------|---------|------|------|
| 🔴 **最高** | 真实传感器集成 | Ingress层 | 2-3周 | 传感器硬件设备 | ✅ **已完成** |
| 🔴 **最高** | 传感器健康监控 | Ingress层 | 1周 | 无 | ✅ **已完成** |
| 🔴 **最高** | 通信层开发 | Communication项目 | 3-4周 | RuleEngine已部署 | ✅ **已完成** 🆕 |
| 🔴 **最高** | 多厂商硬件驱动 | Drivers层扩展 | 2-3周 | PLC设备和驱动 | 进行中 |
| 🟡 **中等** | 整合与测试 | 所有层 | 3-4周 | 前面阶段完成 | ⚠️ 部分完成 |
| 🟢 **低** | 生产功能 | 各层 | 持续开发 | 核心功能稳定 | 待开始 |

**总体时间线**：完成核心功能（阶段1-4）预计需要 **8-12周**（阶段1和3已完成，节省5-7周）

**成功标准**：
- ✅ 真实传感器能自动感应包裹并创建记录
- ✅ 传感器健康监控能自动检测故障
- ✅ 传感器错误能自动报告和处理
- ✅ 系统能通过TCP/SignalR/MQTT与RuleEngine通信 🆕
- ✅ ParcelSortingOrchestrator完整集成传感器→RuleEngine→执行流程 🆕
- ⚠️ 支持至少3种主流PLC厂商（雷赛✅、西门子、三菱/欧姆龙）
- ⚠️ 完整的包裹分拣流程可以端到端运行（待RuleEngine联调测试）
- ❌ 真实硬件环境下稳定运行24小时以上
- ❌ 生产环境禁用HTTP，仅用TCP/SignalR/MQTT（已实现，待部署验证）
- ❌ 核心逻辑测试覆盖率达到80%以上

详细的系统关系和集成方案请参阅：[与规则引擎的关系文档](RELATIONSHIP_WITH_RULEENGINE.md)

---

## 项目结构

- **ZakYip.WheelDiverterSorter.Core**: 核心业务逻辑，包含路径生成器接口和实现
- **ZakYip.WheelDiverterSorter.Execution**: 执行层，包含路径执行器接口和模拟实现
- **ZakYip.WheelDiverterSorter.Drivers**: 🆕 硬件驱动层，包含PLC控制器驱动和IO端口抽象
- **ZakYip.WheelDiverterSorter.Host**: Web API 主机，提供调试接口和配置管理API
- **ZakYip.WheelDiverterSorter.Ingress**: 入口管理（✅ **已完成**：真实传感器和健康监控已实现）
- **ZakYip.WheelDiverterSorter.Observability**: 可观测性支持（待实现）
- **ZakYip.WheelDiverterSorter.Communication**: 通信层（✅ **已完成** 🆕：TCP/SignalR/MQTT/HTTP客户端全部实现）

## 项目运行流程

### 系统启动流程

1. **启动Web API主机**
   ```bash
   cd ZakYip.WheelDiverterSorter.Host
   dotnet run
   ```
   - 默认监听端口：5000（HTTP）
   - 自动注册依赖服务（路径生成器、执行器）

2. **系统初始化**
   - 加载摆轮拓扑配置（当前使用硬编码映射）
   - 初始化路径生成器和执行器
   - 启动Web API监听

### 包裹分拣流程

#### 完整工作流程（生产环境）

```
IO传感器感应 → 创建包裹 → 请求格口号(TCP/SignalR/MQTT) → RuleEngine决策 
→ 接收格口号 → 生成摆轮路径 → 执行路径 → 到达目标格口
```

#### 当前流程（测试环境）

```
手动触发HTTP API → 生成摆轮路径 → 执行路径 → 到达目标格口
```

#### 详细步骤说明

1. **包裹入口**
   - **生产模式（待实现）**：
     - IO传感器感应包裹到达
     - 自动创建包裹记录并生成包裹ID
     - 通过TCP/SignalR/MQTT向RuleEngine.Core请求格口号
     - RuleEngine与DWS第三方API通信获取包裹信息
     - RuleEngine返回目标格口ID
   - **调试模式（当前实现）**：
     - 通过HTTP API手动触发 `POST /api/debug/sort`
     - 直接提供包裹ID和目标格口ID
     - ⚠️ 此模式仅用于测试，生产环境禁用HTTP

2. **路径生成阶段** (`ISwitchingPathGenerator`)
   - 接收包裹ID和目标格口ID
   - 查询格口到摆轮的映射关系
   - 生成有序的摆轮路径段列表（`SwitchingPath`）
   - 每段包含：摆轮ID、目标角度、TTL（超时时间）
   - 如果格口未配置，返回null，包裹将走异常口

3. **路径执行阶段** (`ISwitchingPathExecutor`)
   - 按顺序执行每个路径段
   - 模拟执行器：模拟设备响应延迟
   - 真实执行器（待实现）：与PLC/设备通信，控制摆轮角度
   - 监控每段的TTL，超时则标记失败

4. **结果反馈**
   - 执行成功：返回目标格口ID
   - 执行失败：返回异常格口ID和失败原因
   - 记录执行日志供后续分析

## 工作原理

### 核心概念

#### 1. 摆轮（Wheel Diverter）

摆轮是安装在直线输送线上的分拣设备，通过旋转不同角度将包裹分流到不同方向：

- **0度**：包裹直行通过
- **30度/45度**：小角度分流（常用于相邻格口）
- **90度**：大角度分流（常用于垂直分拣）

#### 2. 直线拓扑结构

```
入口 → 摆轮D1 → 摆轮D2 → 摆轮D3 → 末端
        ↓         ↓         ↓
     格口B      格口A     格口C
```

包裹在输送线上单向移动，经过配置的摆轮节点时，根据路径指令分流到目标格口。

#### 3. 路径规划

**当前实现（硬编码映射）**：
```csharp
// 格口A：需要经过摆轮D1（30度）和摆轮D2（45度）
"CHUTE_A" -> [D1:30°, D2:45°]

// 格口B：需要经过摆轮D1（0度直行）
"CHUTE_B" -> [D1:0°]

// 格口C：需要经过摆轮D1（90度）和摆轮D3（30度）
"CHUTE_C" -> [D1:90°, D3:30°]
```

**未来实现（基于拓扑的动态路径搜索）**：
- 从拓扑模型 (`SorterTopology`) 自动计算最优路径
- 支持多条路径选择和负载均衡
- 考虑设备状态和故障节点

#### 4. 路径段与TTL

每个路径段包含：
- **摆轮ID**：指定哪个摆轮执行动作
- **目标角度**：摆轮应旋转到的角度
- **TTL（Time To Live）**：该段的最大执行时间（默认5000ms）

如果段执行超过TTL，视为失败，包裹将被引导到异常格口。

#### 5. 异常处理机制

- **路径生成失败**：目标格口未配置 → 返回null → 包裹走异常口
- **路径执行失败**：段超时或设备故障 → 返回失败结果 → 包裹走异常口
- **异常格口**：默认为 `CHUTE_EXCEPTION`，用于收集所有异常包裹

## 调试接口

### 概述

Host 层提供了一个用于调试直线摆轮方案的最小接口。

**注意**：这是调试入口，正式环境可改成由扫码触发或供包台触发。

### API 端点

**POST** `/api/debug/sort`

#### 请求参数

```json
{
  "parcelId": "包裹ID",
  "targetChuteId": "目标格口ID"
}
```

#### 响应示例

成功案例：
```json
{
  "parcelId": "PKG001",
  "targetChuteId": "CHUTE_A",
  "isSuccess": true,
  "actualChuteId": "CHUTE_A",
  "message": "分拣成功：包裹 PKG001 已成功分拣到格口 CHUTE_A",
  "failureReason": null,
  "pathSegmentCount": 2
}
```

失败案例（未知格口）：
```json
{
  "parcelId": "PKG004",
  "targetChuteId": "CHUTE_UNKNOWN",
  "isSuccess": false,
  "actualChuteId": "未知",
  "message": "路径生成失败：目标格口无法映射到任何摆轮组合",
  "failureReason": "目标格口未配置或不存在",
  "pathSegmentCount": 0
}
```

### 使用示例

```bash
curl -X POST http://localhost:5000/api/debug/sort \
  -H "Content-Type: application/json" \
  -d '{"parcelId": "PKG001", "targetChuteId": "CHUTE_A"}'
```

### 工作流程

1. 接收包裹ID和目标格口ID
2. 调用路径生成器（`ISwitchingPathGenerator`）生成 `SwitchingPath`
3. 调用执行器（`ISwitchingPathExecutor`）执行路径
4. 返回执行结果和实际落格ID

### 预配置的格口

当前默认配置包含以下格口映射：

- **CHUTE_A**: 需要经过摆轮D1（30度）和摆轮D2（45度）
- **CHUTE_B**: 需要经过摆轮D1（0度直行）
- **CHUTE_C**: 需要经过摆轮D1（90度）和摆轮D3（30度）

**注意**: 这些配置存储在 LiteDB 数据库中，可以通过配置管理 API 动态修改。

## 配置管理 API

系统提供了完整的 RESTful API 用于动态管理格口到摆轮的路由配置，支持热更新（无需重启）。

### 主要功能

- ✅ **动态配置管理**: 通过 API 添加、修改、删除格口配置
- ✅ **热更新支持**: 配置更改立即生效，无需重启应用
- ✅ **数据持久化**: 使用 LiteDB 存储配置数据
- ✅ **配置验证**: 自动验证配置的正确性和完整性

### API 端点

| 方法 | 端点 | 说明 |
|------|------|------|
| GET | `/api/config/routes` | 获取所有路由配置 |
| GET | `/api/config/routes/{chuteId}` | 获取指定格口配置 |
| POST | `/api/config/routes` | 创建新的路由配置 |
| PUT | `/api/config/routes/{chuteId}` | 更新路由配置（热更新） |
| DELETE | `/api/config/routes/{chuteId}` | 删除路由配置 |

### 快速示例

```bash
# 创建新格口配置
curl -X POST http://localhost:5000/api/config/routes \
  -H "Content-Type: application/json" \
  -d '{
    "chuteId": "CHUTE_D",
    "diverterConfigurations": [
      {"diverterId": "D2", "targetAngle": 45, "sequenceNumber": 1},
      {"diverterId": "D3", "targetAngle": 90, "sequenceNumber": 2}
    ],
    "isEnabled": true
  }'

# 立即使用新配置（无需重启）
curl -X POST http://localhost:5000/api/debug/sort \
  -H "Content-Type: application/json" \
  -d '{"parcelId": "PKG001", "targetChuteId": "CHUTE_D"}'
```

详细的 API 文档请参阅：[配置管理 API 文档](CONFIGURATION_API.md)

## 运行项目

```bash
cd ZakYip.WheelDiverterSorter.Host
dotnet run
```

默认监听端口：5000（HTTP）

## 存在的隐患和待改进项

### 🔴 高优先级隐患

#### 1. ~~硬编码配置依赖~~ ✅ 已解决
- **问题**：格口到摆轮的映射关系硬编码在 `DefaultSwitchingPathGenerator` 中
- **风险**：添加或修改格口需要重新编译和部署代码
- **影响**：生产环境灵活性差，维护成本高
- **解决方案**：
  - ✅ 使用 LiteDB 存储配置，支持动态管理
  - ✅ 提供完整的 RESTful API 进行配置管理
  - ✅ 支持热更新，配置更改立即生效无需重启
  - ✅ 详见 [配置管理 API 文档](CONFIGURATION_API.md)

#### 2. 硬件驱动覆盖不足 🆕
- **问题**：当前仅支持雷赛（Leadshine）控制器，其他主流PLC厂商未支持
- **风险**：限制了系统在不同硬件环境下的部署灵活性
- **影响**：无法在使用西门子、三菱、欧姆龙等PLC的现场部署
- **建议**：
  - 实现西门子S7系列PLC驱动（S7-200/300/1200/1500）
  - 实现三菱FX/Q系列PLC驱动
  - 实现欧姆龙CP/CJ/NJ系列PLC驱动
  - 建立驱动插件化架构，支持第三方驱动扩展
  - 提供驱动开发SDK和文档

#### 3. 缺少真实传感器驱动 ✅ **已解决** 🆕
- **问题**：~~Ingress层仅实现了模拟传感器，无真实硬件传感器驱动~~
- **风险**：~~无法在生产环境中自动感应物理包裹~~
- **影响**：~~系统无法自动触发分拣流程，仍依赖手动触发~~
- **解决方案**：✅ **已完成**
  - ✅ 集成雷赛真实光电传感器驱动
  - ✅ 集成雷赛真实激光传感器驱动
  - ✅ 实现传感器工厂模式，支持多种传感器品牌
  - ✅ 添加传感器状态监控和故障检测
  - ✅ 实现传感器健康监控服务
  - ✅ 实现传感器错误报告机制

#### 4. 缺少与RuleEngine的通信层
- **问题**：无法与RuleEngine.Core通信获取格口号
- **风险**：系统功能不完整，无法自动获取包裹的目标格口
- **影响**：无法实现端到端的自动分拣流程
- **建议**：
  - 实现TCP Socket通信客户端（高性能）
  - 实现SignalR通信客户端（实时双向）
  - 实现MQTT通信客户端（IoT场景）
  - 实现连接管理、重连、超时、重试机制
  - 禁用HTTP通信（仅用于测试，生产环境性能不足）

#### 5. 无单元测试和集成测试
- **问题**：项目中没有任何测试代码
- **风险**：代码重构或新增功能时易引入bug，难以保证质量
- **影响**：系统稳定性无法保障，回归测试成本高
- **建议**：
  - 为核心路径生成逻辑添加单元测试（目标覆盖率>80%）
  - 为API端点添加集成测试
  - 为硬件驱动添加Mock设备测试
  - 引入测试覆盖率工具（coverlet）
  - 添加CI/CD自动化测试流程

#### 6. 缺少并发控制
- **问题**：多个包裹同时请求同一摆轮时，可能产生冲突
- **风险**：摆轮角度切换频繁，降低分拣效率或导致分拣错误
- **影响**：高并发场景下系统不可用或分拣错误率高
- **建议**：
  - 实现摆轮资源锁机制（读写锁或信号量）
  - 添加包裹队列管理（优先级队列）
  - 优化路径调度算法，批量处理相同目标的包裹
  - 实现动态负载均衡
  - 添加并发限流保护

### 🟡 中优先级问题

#### 7. 硬件驱动错误处理不完善 ⚠️ **部分解决** 🆕
- **问题**：~~硬件执行器虽然捕获了异常，但错误分类和恢复策略不够详细~~
- **风险**：~~无法准确判断故障原因，影响问题定位和修复~~
- **影响**：设备故障时排查困难，恢复时间长
- **进展**：✅ **已改进**
  - ✅ 传感器层已实现详细的错误事件系统
  - ✅ 传感器健康监控服务可以分类故障类型
  - ✅ 实现了故障检测和自动恢复检测
  - ⚠️ 执行器层和摆轮控制器层的错误处理仍需增强
- **后续建议**：
  - 细化执行器和控制器错误分类
  - 实现错误自动恢复策略（重试、重置、切换备用设备）
  - 添加设备健康检查和预警机制
  - 提供设备故障自动告警

#### 8. 静态TTL设置
- **问题**：所有路径段使用固定5000ms的TTL
- **风险**：无法适应不同距离的摆轮节点或不同速度的输送线
- **影响**：可能导致不必要的超时或资源浪费
- **建议**：
  - 根据摆轮位置和输送速度动态计算TTL
  - 支持在拓扑配置中为每个节点设置不同TTL
  - 添加TTL自适应调整机制（基于历史执行时间）
  - 实现TTL预警和异常检测

#### 9. 简单的路径生成算法
- **问题**：当前使用直接映射，不考虑设备状态和负载
- **风险**：无法处理设备故障、维护场景
- **影响**：缺少容错能力和优化空间
- **建议**：
  - 实现基于拓扑图的Dijkstra/A*路径搜索
  - 支持动态路径重规划（设备故障时）
  - 考虑设备负载均衡
  - 支持多路径选择和权重优化
  - 实现路径缓存和预计算

#### 10. 日志注入防护不完整
- **问题**：虽然实现了基本的日志清理，但可能不够全面
- **风险**：潜在的日志注入攻击风险
- **影响**：安全性问题，可能被恶意利用
- **建议**：
  - 使用结构化日志（如Serilog）替代字符串拼接
  - 添加输入验证和白名单机制
  - 定期安全审计
  - 实现日志脱敏（敏感信息掩码）
  - 启用日志完整性校验

#### 11. 缺少可观测性 ⚠️ **部分改进** 🆕
- **问题**：无指标收集、链路追踪、告警机制
- **风险**：生产环境问题难以排查和监控
- **影响**：运维困难，故障响应慢，MTTR（平均修复时间）高
- **进展**：✅ **传感器层已改进**
  - ✅ 实现传感器健康监控和故障检测
  - ✅ 实现传感器状态统计（触发次数、错误次数、运行时长）
  - ✅ 通过事件系统支持故障告警
  - ⚠️ 其他层的可观测性仍需增强
- **后续建议**：
  - 集成Prometheus/Grafana进行指标监控
  - 集成OpenTelemetry进行链路追踪
  - 添加关键指标：分拣成功率、平均响应时间、设备可用性、错误率等
  - 实现告警通知（钉钉/邮件/短信/Webhook）
  - 构建实时监控仪表板

#### 12. 硬件驱动DLL管理 🆕
- **问题**：雷赛LTDMC.dll等原生DLL需要手动部署
- **风险**：部署复杂度增加，容易遗漏或版本不匹配
- **影响**：部署失败率高，难以自动化部署
- **建议**：
  - 使用NuGet打包原生DLL
  - 实现DLL版本检查和自动下载
  - 提供Docker镜像预装所有驱动
  - 编写自动化部署脚本
  - 添加DLL依赖检查工具

### 🟢 低优先级优化

#### 13. 缺少包裹跟踪和历史记录
- **问题**：无法查询包裹的历史分拣记录
- **影响**：问题溯源困难，无法进行数据分析
- **建议**：
  - 添加数据库持久化（MySQL/PostgreSQL）
  - 记录每个包裹的完整路径和状态变更
  - 提供查询接口和Web界面
  - 实现数据归档和清理策略
  - 添加数据分析和报表功能

#### 14. API文档不完整
- **问题**：缺少Swagger/OpenAPI文档
- **影响**：接口使用不便，开发效率低
- **建议**：
  - 集成Swashbuckle.AspNetCore
  - 生成交互式API文档
  - 添加API示例和说明
  - 提供Postman/Insomnia集合
  - 编写API使用教程

#### 15. 配置管理不灵活
- **问题**：部分配置（异常格口ID、端口等）仍然硬编码
- **影响**：环境迁移不便
- **建议**：
  - 使用appsettings.json管理所有配置
  - 支持环境变量覆盖
  - 添加配置验证和默认值
  - 实现配置热重载
  - 提供配置模板和示例

#### 16. 缺少性能优化
- **问题**：未进行性能测试和优化
- **影响**：高吞吐量场景下性能未知
- **建议**：
  - 进行压力测试（Apache JMeter/k6）
  - 添加性能计数器和指标
  - 优化热点代码路径（使用BenchmarkDotNet）
  - 实现对象池和缓存机制
  - 数据库查询优化和索引

### 安全隐患总结

| 隐患类型 | 严重程度 | 是否已修复 | 备注 |
|---------|---------|-----------|------|
| 真实传感器缺失 | 高 | ✅ 是 | 🆕 雷赛传感器驱动已完成 |
| 传感器健康监控 | 中 | ✅ 是 | 🆕 健康监控服务已实现 |
| 日志注入 | 中 | 部分 | 已有基础防护，建议使用结构化日志 |
| 并发冲突 | 高 | 否 | 需要资源锁机制 |
| 配置泄露 | 中 | 否 | 建议使用密钥管理服务 |
| 输入验证 | 低 | 部分 | API有基础验证，建议完善 |
| 硬件通信安全 | 中 | 否 🆕 | 需要加密PLC通信，防止中间人攻击 |
| DLL劫持 | 中 | 否 🆕 | 需要验证原生DLL签名和完整性 |

### 🆕 新增风险（硬件驱动层和传感器层）

| 风险项 | 描述 | 影响 | 建议 | 状态 |
|-------|------|------|------|------|
| 硬件兼容性 | 不同型号PLC协议可能不同 | 驱动失效或功能异常 | 详细测试各型号，建立兼容性列表 | ⚠️ 需注意 |
| 驱动版本冲突 | 不同厂商DLL可能冲突 | 系统崩溃或行为异常 | 使用独立AppDomain或进程隔离 | ⚠️ 需注意 |
| 设备掉线 | 网络中断或设备断电 | 分拣中断，包裹堆积 | ✅ 已实现自动检测和告警 | ✅ 已解决 |
| 传感器故障 | 传感器硬件损坏或读取错误 | 无法检测包裹，分拣停滞 | ✅ 已实现健康监控和故障检测 | ✅ 已解决 |
| 指令延迟 | PLC响应慢或网络延迟高 | 分拣效率低或超时 | 优化通信协议，添加预读机制 | ⚠️ 需优化 |
| 固件版本差异 | 旧版本PLC可能不支持某些指令 | 功能受限或不可用 | 检查固件版本，提供兼容模式 | ⚠️ 需注意 |
| 传感器误触发 | 环境干扰或灵敏度过高 | 错误检测包裹，影响准确性 | ✅ 已实现去抖动机制 | ✅ 已解决 |

## 开发

### 构建

```bash
dotnet build
```

### 测试

```bash
dotnet test
```

注意：当前项目无测试，此命令不会执行任何测试。

---

## 📝 当前欠缺内容总结

本节总结项目中当前仍然缺失的关键功能和模块，为后续开发提供清晰的任务列表。

### 🔴 关键缺失功能（影响生产部署）

| 序号 | 缺失模块 | 描述 | 影响 | 优先级 | 状态 |
|-----|---------|------|------|--------|------|
| 1 | **真实传感器驱动** | ~~仅有模拟传感器，缺少真实硬件传感器驱动集成~~ | ~~无法自动感应包裹，必须手动触发~~ | 🔴 极高 | ✅ **已完成** |
| 2 | **通信层** | 完全缺失与RuleEngine.Core的通信客户端 | 无法自动获取格口号，功能不完整 | 🔴 极高 | ❌ 待开发 |
| 3 | **多厂商PLC支持** | 仅支持雷赛控制器，不支持西门子/三菱/欧姆龙等 | 限制部署场景，无法在其他PLC环境使用 | 🔴 高 | ❌ 待开发 |
| 4 | **并发控制机制** | 缺少摆轮资源锁和包裹队列管理 | 高并发下可能冲突，分拣错误或效率低 | 🔴 高 | ❌ 待开发 |
| 5 | **测试框架** | 完全没有单元测试和集成测试 | 代码质量无法保证，回归测试困难 | 🔴 高 | ❌ 待开发 |

### 🟡 重要缺失功能（影响运维和优化）

| 序号 | 缺失模块 | 描述 | 影响 | 优先级 |
|-----|---------|------|------|--------|
| 6 | **可观测性** | 缺少指标收集、链路追踪、告警系统 | 故障排查困难，无法实时监控 | 🟡 中 |
| 7 | **包裹跟踪** | 无历史记录和查询功能 | 无法追溯问题，数据分析受限 | 🟡 中 |
| 8 | **动态路径算法** | 仅支持静态映射，不支持路径优化 | 无容错能力，无法应对设备故障 | 🟡 中 |
| 9 | **设备健康检查** | 缺少设备状态监控和预警 | 设备故障发现不及时 | 🟡 中 |
| 10 | **性能优化** | 未进行性能测试和优化 | 高吞吐量场景性能未知 | 🟡 中 |

### 🟢 辅助功能（提升用户体验）

| 序号 | 缺失模块 | 描述 | 影响 | 优先级 |
|-----|---------|------|------|--------|
| 11 | **Web管理界面** | 缺少可视化管理界面 | 配置管理依赖API调用，不直观 | 🟢 低 |
| 12 | **API文档** | 缺少Swagger/OpenAPI文档 | API使用不便，学习成本高 | 🟢 低 |
| 13 | **扫码触发** | 无扫码器集成 | 无法通过扫码启动分拣 | 🟢 低 |
| 14 | **供包台接口** | 无供包台系统集成 | 无法与供包台联动 | 🟢 低 |
| 15 | **数据报表** | 无统计报表和数据分析 | 运营数据无法可视化 | 🟢 低 |

### 📋 分层模块完整性分析

#### ✅ 已完成的层

| 层 | 完成度 | 说明 |
|----|--------|------|
| **Core层** | 100% | 路径生成、配置管理完全实现 |
| **Execution层** | 100% | 模拟和硬件执行器都已实现 |
| **Host层** | 90% | API端点完整，缺少Swagger文档 |

#### 🚧 部分完成的层

| 层 | 完成度 | 已完成 | 缺失 |
|----|--------|--------|------|
| **Drivers层** | 80% | 雷赛驱动、IO抽象 | 西门子/三菱/欧姆龙驱动 |
| **Ingress层** | 85% | 真实传感器驱动、健康监控、检测服务 | 扫码集成、供包台集成 |
| **Observability层** | 30% | 基础日志 | 指标收集、链路追踪、告警 |

#### ❌ 未完成的层

| 层 | 完成度 | 缺失内容 |
|----|--------|----------|
| **Communication层** | 0% | TCP/SignalR/MQTT客户端、连接管理、错误处理 |

### 🔧 技术债务清单

| 技术债务 | 描述 | 建议 |
|---------|------|------|
| 硬编码配置残留 | 异常格口ID等仍硬编码 | 全部移至配置文件 |
| 单一PLC厂商 | 仅支持雷赛 | 扩展插件化架构 |
| 同步IO操作 | 部分IO操作未异步化 | 全面异步化改造 |
| 静态TTL | 固定5000ms超时 | 动态计算TTL |
| 日志字符串拼接 | 存在日志注入风险 | 改用结构化日志 |
| 无资源池 | 连接和对象未池化 | 实现对象池和连接池 |
| 缺少事务 | 配置更新无事务保护 | 添加事务支持 |
| 无缓存机制 | 频繁查询数据库 | 实现配置缓存 |

### 📊 功能完整性矩阵

| 功能域 | 核心功能 | 扩展功能 | 监控运维 | 测试质量 |
|-------|---------|---------|---------|---------|
| **路径规划** | ✅ 100% | ⚠️ 30% | ❌ 0% | ❌ 0% |
| **路径执行** | ✅ 100% | ⚠️ 50% | ❌ 0% | ❌ 0% |
| **硬件驱动** | ⚠️ 80% | ⚠️ 40% | ⚠️ 20% | ❌ 0% |
| **包裹入口** | ✅ 85% | ⚠️ 20% | ✅ 60% | ❌ 0% |
| **外部通信** | ❌ 0% | ❌ 0% | ❌ 0% | ❌ 0% |
| **配置管理** | ✅ 100% | ✅ 80% | ⚠️ 40% | ❌ 0% |
| **可观测性** | ⚠️ 30% | ❌ 0% | ⚠️ 30% | ❌ 0% |

**图例**：
- ✅ 完成（80%-100%）
- ⚠️ 部分完成（30%-79%）
- ❌ 未完成（0%-29%）

### 🎯 补齐优先级建议

根据影响范围和紧急程度，建议按以下顺序补齐缺失功能：

**第一批（已完成）**：
1. ✅ 真实传感器驱动集成
2. ✅ 传感器健康监控系统
3. ✅ 传感器错误处理和报告

**第二批（1-2个月）- 必须完成**：
4. 通信层完整实现
5. 并发控制机制
6. 核心功能单元测试（覆盖率>60%）

**第三批（3-4个月）- 重要功能**：
7. 西门子/三菱PLC驱动
8. 可观测性基础设施（Prometheus+Grafana）
9. 包裹跟踪和历史记录
10. 设备健康检查和告警

**第四批（5-6个月）- 优化改进**：
11. 动态路径算法
12. Web管理界面
13. API文档（Swagger）
14. 性能优化和压力测试

**持续改进**：
13. 技术债务清理
14. 测试覆盖率提升（目标>80%）
15. 安全加固
16. 文档完善

---

## 技术栈

- **.NET 8.0**: 核心框架
- **ASP.NET Core Minimal API**: Web API框架
- **依赖注入（DI）**: 服务管理
- **Record类型**: 不可变数据模型

## 贡献指南

1. Fork本仓库
2. 创建特性分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 创建Pull Request

## 许可证

待定

## 联系方式

项目维护者：待补充

---

## 🧪 测试 (Testing)

项目包含全面的单元测试和代码覆盖率工具。

The project includes comprehensive unit tests and code coverage tools.

### 运行测试 (Run Tests)

```bash
# 运行所有测试
dotnet test

# 运行测试并生成覆盖率报告
dotnet test --collect:"XPlat Code Coverage" --results-directory ./TestResults
```

### 测试项目 (Test Projects)

- **ZakYip.WheelDiverterSorter.Core.Tests**: 核心路径生成逻辑单元测试
- **ZakYip.WheelDiverterSorter.Drivers.Tests**: 硬件驱动Mock设备测试

### 代码覆盖率 (Code Coverage)

- 目标覆盖率 >80%
- 使用 coverlet 进行覆盖率收集
- CI/CD 自动检查覆盖率阈值

详细测试文档请查看 [TESTING.md](TESTING.md)

For detailed testing documentation, see [TESTING.md](TESTING.md)

---
