# Prometheus Alert Rules for Wheel Diverter Sorter System
# 摆轮分拣系统Prometheus告警规则

groups:
  - name: sorter_alerts
    interval: 30s
    rules:
      # 高失败率告警 / High failure rate alert
      - alert: HighSortingFailureRate
        expr: |
          (
            rate(sorter_sorting_failure_total[5m]) / 
            (rate(sorter_sorting_success_total[5m]) + rate(sorter_sorting_failure_total[5m]))
          ) > 0.1
        for: 5m
        labels:
          severity: warning
          component: sorting
        annotations:
          summary: "高分拣失败率 / High sorting failure rate"
          description: "失败率超过10% (当前值: {{ $value | humanizePercentage }}) / Failure rate exceeds 10% (current: {{ $value | humanizePercentage }})"
          dashboard: "http://grafana:3000/d/wheel-diverter-sorter/wheel-diverter-sorter-dashboard"

      # 吞吐量下降告警 / Throughput drop alert
      - alert: LowThroughput
        expr: rate(sorter_parcel_throughput_total[5m]) * 60 < 10
        for: 5m
        labels:
          severity: warning
          component: throughput
        annotations:
          summary: "吞吐量过低 / Low throughput"
          description: "包裹吞吐量低于10个/分钟 (当前值: {{ $value | printf \"%.1f\" }}) / Parcel throughput below 10 per minute (current: {{ $value | printf \"%.1f\" }})"
          dashboard: "http://grafana:3000/d/wheel-diverter-sorter/wheel-diverter-sorter-dashboard"

      # 队列积压告警 / Queue backlog alert
      - alert: HighQueueLength
        expr: sorter_queue_length > 100
        for: 2m
        labels:
          severity: warning
          component: queue
        annotations:
          summary: "队列积压 / Queue backlog"
          description: "队列长度超过100 (当前值: {{ $value }}) / Queue length exceeds 100 (current: {{ $value }})"
          dashboard: "http://grafana:3000/d/wheel-diverter-sorter/wheel-diverter-sorter-dashboard"

      # 队列等待时间过长告警 / Long queue wait time alert
      - alert: HighQueueWaitTime
        expr: |
          (
            rate(sorter_queue_wait_time_seconds_sum[5m]) /
            rate(sorter_queue_wait_time_seconds_count[5m])
          ) > 10
        for: 5m
        labels:
          severity: warning
          component: queue
        annotations:
          summary: "队列等待时间过长 / High queue wait time"
          description: "平均等待时间超过10秒 (当前值: {{ $value | printf \"%.2f\" }}s) / Average wait time exceeds 10 seconds (current: {{ $value | printf \"%.2f\" }}s)"
          dashboard: "http://grafana:3000/d/wheel-diverter-sorter/wheel-diverter-sorter-dashboard"

      # RuleEngine连接断开告警 / RuleEngine disconnection alert
      - alert: RuleEngineDisconnected
        expr: sorter_ruleengine_connection_status == 0
        for: 1m
        labels:
          severity: critical
          component: ruleengine
        annotations:
          summary: "RuleEngine连接断开 / RuleEngine disconnected"
          description: "RuleEngine连接类型 {{ $labels.connection_type }} 已断开 / RuleEngine connection type {{ $labels.connection_type }} is disconnected"
          dashboard: "http://grafana:3000/d/wheel-diverter-sorter/wheel-diverter-sorter-dashboard"

      # 传感器故障告警 / Sensor fault alert
      - alert: SensorFault
        expr: sorter_sensor_health_status == 0
        for: 1m
        labels:
          severity: critical
          component: sensor
        annotations:
          summary: "传感器故障 / Sensor fault"
          description: "传感器 {{ $labels.sensor_id }} ({{ $labels.sensor_type }}) 故障 / Sensor {{ $labels.sensor_id }} ({{ $labels.sensor_type }}) is faulty"
          dashboard: "http://grafana:3000/d/wheel-diverter-sorter/wheel-diverter-sorter-dashboard"

      # 高传感器错误率告警 / High sensor error rate alert
      - alert: HighSensorErrorRate
        expr: rate(sorter_sensor_errors_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          component: sensor
        annotations:
          summary: "传感器错误率过高 / High sensor error rate"
          description: "传感器 {{ $labels.sensor_id }} 错误率过高 ({{ $value | printf \"%.2f\" }}/s) / Sensor {{ $labels.sensor_id }} error rate is too high ({{ $value | printf \"%.2f\" }}/s)"
          dashboard: "http://grafana:3000/d/wheel-diverter-sorter/wheel-diverter-sorter-dashboard"

      # 路径执行时间过长告警 / Long path execution time alert
      - alert: SlowPathExecution
        expr: |
          histogram_quantile(0.95, 
            rate(sorter_path_execution_duration_seconds_bucket[5m])
          ) > 5
        for: 5m
        labels:
          severity: warning
          component: performance
        annotations:
          summary: "路径执行缓慢 / Slow path execution"
          description: "P95路径执行时间超过5秒 (当前值: {{ $value | printf \"%.2f\" }}s) / P95 path execution time exceeds 5 seconds (current: {{ $value | printf \"%.2f\" }}s)"
          dashboard: "http://grafana:3000/d/wheel-diverter-sorter/wheel-diverter-sorter-dashboard"

      # 路径生成时间过长告警 / Long path generation time alert
      - alert: SlowPathGeneration
        expr: |
          histogram_quantile(0.95, 
            rate(sorter_path_generation_duration_seconds_bucket[5m])
          ) > 1
        for: 5m
        labels:
          severity: warning
          component: performance
        annotations:
          summary: "路径生成缓慢 / Slow path generation"
          description: "P95路径生成时间超过1秒 (当前值: {{ $value | printf \"%.2f\" }}s) / P95 path generation time exceeds 1 second (current: {{ $value | printf \"%.2f\" }}s)"
          dashboard: "http://grafana:3000/d/wheel-diverter-sorter/wheel-diverter-sorter-dashboard"

      # 没有活跃请求告警 / No active requests alert
      - alert: NoActiveRequests
        expr: sorter_active_requests == 0
        for: 10m
        labels:
          severity: info
          component: monitoring
        annotations:
          summary: "系统空闲 / System idle"
          description: "系统已空闲10分钟，没有活跃的分拣请求 / System has been idle for 10 minutes with no active sorting requests"
          dashboard: "http://grafana:3000/d/wheel-diverter-sorter/wheel-diverter-sorter-dashboard"

      # 摆轮使用率过高告警 / High diverter utilization alert
      - alert: HighDiverterUtilization
        expr: sorter_diverter_utilization_ratio > 0.9
        for: 5m
        labels:
          severity: warning
          component: diverter
        annotations:
          summary: "摆轮使用率过高 / High diverter utilization"
          description: "摆轮 {{ $labels.diverter_id }} 使用率超过90% (当前值: {{ $value | humanizePercentage }}) / Diverter {{ $labels.diverter_id }} utilization exceeds 90% (current: {{ $value | humanizePercentage }})"
          dashboard: "http://grafana:3000/d/wheel-diverter-sorter/wheel-diverter-sorter-dashboard"

      # Prometheus目标不可达告警 / Prometheus target down alert
      - alert: PrometheusTargetDown
        expr: up == 0
        for: 2m
        labels:
          severity: critical
          component: monitoring
        annotations:
          summary: "Prometheus目标不可达 / Prometheus target down"
          description: "目标 {{ $labels.job }} ({{ $labels.instance }}) 已离线超过2分钟 / Target {{ $labels.job }} ({{ $labels.instance }}) has been down for more than 2 minutes"
          dashboard: "http://grafana:3000/d/wheel-diverter-sorter/wheel-diverter-sorter-dashboard"
