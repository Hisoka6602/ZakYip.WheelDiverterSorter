name: Simulation and E2E Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  simulation-tests:
    name: Run Simulation and E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build solution
      run: dotnet build --no-restore --configuration Release
    
    - name: Run E2E Tests
      run: |
        dotnet test tests/ZakYip.WheelDiverterSorter.E2ETests \
          --no-build \
          --configuration Release \
          --verbosity normal \
          --logger "trx;LogFileName=e2e-test-results.trx" \
          --collect:"XPlat Code Coverage" \
          --results-directory ./TestResults/E2E
      continue-on-error: false
    
    - name: Run Simulation Scenarios
      run: |
        # Run specific simulation test categories
        dotnet test tests/ZakYip.WheelDiverterSorter.E2ETests \
          --no-build \
          --configuration Release \
          --filter "FullyQualifiedName~Simulation" \
          --verbosity normal \
          --logger "trx;LogFileName=simulation-test-results.trx" \
          --results-directory ./TestResults/Simulation
      continue-on-error: false
    
    - name: Verify Critical Scenarios
      run: |
        echo "âœ“ Verifying critical end-to-end scenarios..."
        echo "  - API Configuration â†’ IO Startup â†’ Panel Start â†’ Parcel Creation"
        echo "  - Upstream Routing â†’ Diverter Switching â†’ Chute Landing"
        echo "  - Communication Retry Scenarios"
        echo "  - Upstream Delay Handling"
        echo "  - Emergency Stop Scenarios"
        
        # Run Host Integration Tests that cover full workflows
        dotnet test tests/ZakYip.WheelDiverterSorter.Host.IntegrationTests \
          --no-build \
          --configuration Release \
          --verbosity normal \
          --logger "trx;LogFileName=integration-test-results.trx" \
          --results-directory ./TestResults/Integration
      continue-on-error: false
    
    - name: Upload E2E Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: e2e-test-results
        path: TestResults/E2E/**/*.trx
    
    - name: Upload Simulation Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: simulation-test-results
        path: TestResults/Simulation/**/*.trx
    
    - name: Upload Integration Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: integration-test-results
        path: TestResults/Integration/**/*.trx
    
    - name: Test Summary
      if: always()
      run: |
        echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f TestResults/E2E/*.trx ]; then
          echo "### âœ… E2E Tests Completed" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ E2E Tests Failed or Not Run" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f TestResults/Simulation/*.trx ]; then
          echo "### âœ… Simulation Tests Completed" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âš ï¸ Simulation Tests Failed or Not Run" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f TestResults/Integration/*.trx ]; then
          echo "### âœ… Integration Tests Completed" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ Integration Tests Failed or Not Run" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Critical Workflow Coverage:**" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ Configuration API â†’ IO Startup" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ Panel Button State Machine" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ Parcel Creation from Sensor Events" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ Upstream Routing Integration" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ Path Generation and Execution" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ Diverter Switching Operations" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ Successful Chute Landing" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ Communication Retry Logic" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ Upstream Delay Handling" >> $GITHUB_STEP_SUMMARY
        echo "- âœ“ Emergency Stop Scenarios" >> $GITHUB_STEP_SUMMARY
    
    - name: Run SafeExecution Usage Statistics
      if: always()
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“Š SafeExecution Usage Statistics" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        dotnet run --project tools/ZakYip.WheelDiverterSorter.Tools.SafeExecutionStats/ZakYip.WheelDiverterSorter.Tools.SafeExecutionStats.csproj . >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
