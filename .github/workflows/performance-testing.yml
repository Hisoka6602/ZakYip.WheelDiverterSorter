name: Performance Testing

on:
  # ÊâãÂä®Ëß¶Âèë
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Performance test type'
        required: true
        default: 'benchmark'
        type: choice
        options:
          - benchmark
          - k6-smoke
          - k6-load
          - k6-stress
          - k6-high-load
          - all
  # ÂÆöÊúüÊâßË°å - ÊØèÂë®Êó•ÂáåÊô®2ÁÇπ
  schedule:
    - cron: '0 2 * * 0'
  # PR‰∏äÊâßË°åËΩªÈáèÁ∫ßÊµãËØï
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'ZakYip.WheelDiverterSorter.Core/**'
      - 'ZakYip.WheelDiverterSorter.Execution/**'
      - 'ZakYip.WheelDiverterSorter.Benchmarks/**'
      - 'performance-tests/**'

jobs:
  # BenchmarkDotNetÊÄßËÉΩÂü∫ÂáÜÊµãËØï
  benchmark-tests:
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'benchmark' || github.event.inputs.test_type == 'all' || github.event_name == 'schedule'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build Benchmarks
      run: dotnet build ZakYip.WheelDiverterSorter.Benchmarks/ZakYip.WheelDiverterSorter.Benchmarks.csproj --configuration Release --no-restore
    
    - name: Run All Benchmarks
      run: |
        cd ZakYip.WheelDiverterSorter.Benchmarks
        dotnet run -c Release -- --filter * --exporters json,html
      timeout-minutes: 60
    
    - name: Upload Benchmark Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results
        path: |
          ZakYip.WheelDiverterSorter.Benchmarks/BenchmarkDotNet.Artifacts/results/**/*
        retention-days: 30
    
    - name: Check Performance Regression
      run: |
        echo "üìä Benchmark completed. Check artifacts for detailed results."
        echo "‚ö†Ô∏è Manual review required for performance regression analysis."

  # È´òË¥üËΩΩ‰∏ìÈ°πÂü∫ÂáÜÊµãËØï
  high-load-benchmarks:
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'benchmark' || github.event.inputs.test_type == 'all' || github.event_name == 'schedule'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Build Benchmarks
      run: dotnet build ZakYip.WheelDiverterSorter.Benchmarks/ZakYip.WheelDiverterSorter.Benchmarks.csproj --configuration Release
    
    - name: Run High-Load Benchmarks
      run: |
        cd ZakYip.WheelDiverterSorter.Benchmarks
        dotnet run -c Release -- --filter *HighLoadBenchmarks* --exporters json,html
      timeout-minutes: 30
    
    - name: Run Bottleneck Analysis Benchmarks
      run: |
        cd ZakYip.WheelDiverterSorter.Benchmarks
        dotnet run -c Release -- --filter *PerformanceBottleneckBenchmarks* --exporters json,html
      timeout-minutes: 30
    
    - name: Upload High-Load Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: high-load-benchmark-results
        path: |
          ZakYip.WheelDiverterSorter.Benchmarks/BenchmarkDotNet.Artifacts/results/**/*
        retention-days: 90

  # ÂêØÂä®Â∫îÁî®ÊúçÂä°Âô®Áî®‰∫ék6ÊµãËØï
  start-server:
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.test_type == 'k6-smoke' || 
      github.event.inputs.test_type == 'k6-load' || 
      github.event.inputs.test_type == 'k6-stress' ||
      github.event.inputs.test_type == 'k6-high-load' ||
      github.event.inputs.test_type == 'all' ||
      github.event_name == 'schedule'
    outputs:
      server-ready: ${{ steps.health-check.outputs.ready }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Build Application
      run: dotnet build --configuration Release
    
    - name: Start Server
      run: |
        cd ZakYip.WheelDiverterSorter.Host
        nohup dotnet run --configuration Release --no-build &
        echo $! > server.pid
        sleep 10
      
    - name: Health Check
      id: health-check
      run: |
        max_attempts=30
        attempt=0
        while [ $attempt -lt $max_attempts ]; do
          if curl -s http://localhost:5000/health > /dev/null; then
            echo "ready=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Server is ready"
            exit 0
          fi
          echo "‚è≥ Waiting for server... (attempt $((attempt+1))/$max_attempts)"
          sleep 2
          attempt=$((attempt+1))
        done
        echo "ready=false" >> $GITHUB_OUTPUT
        echo "‚ùå Server failed to start"
        exit 1

  # k6ÂÜíÁÉüÊµãËØï
  k6-smoke-test:
    runs-on: ubuntu-latest
    needs: start-server
    if: |
      (github.event.inputs.test_type == 'k6-smoke' || 
       github.event.inputs.test_type == 'all' ||
       github.event_name == 'pull_request') &&
      needs.start-server.outputs.server-ready == 'true'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET and Start Server
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Build and Start Server
      run: |
        dotnet build --configuration Release
        cd ZakYip.WheelDiverterSorter.Host
        nohup dotnet run --configuration Release --no-build &
        sleep 15
    
    - name: Install k6
      run: |
        sudo gpg -k
        sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
        echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
        sudo apt-get update
        sudo apt-get install k6
    
    - name: Run Smoke Test
      run: k6 run --out json=smoke-results.json performance-tests/smoke-test.js
      env:
        BASE_URL: http://localhost:5000
    
    - name: Upload Smoke Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: k6-smoke-test-results
        path: smoke-results.json
        retention-days: 7

  # k6Ë¥üËΩΩÊµãËØï
  k6-load-test:
    runs-on: ubuntu-latest
    needs: start-server
    if: |
      (github.event.inputs.test_type == 'k6-load' || 
       github.event.inputs.test_type == 'all' ||
       github.event_name == 'schedule') &&
      needs.start-server.outputs.server-ready == 'true'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET and Start Server
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Build and Start Server
      run: |
        dotnet build --configuration Release
        cd ZakYip.WheelDiverterSorter.Host
        nohup dotnet run --configuration Release --no-build &
        sleep 15
    
    - name: Install k6
      run: |
        sudo gpg -k
        sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
        echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
        sudo apt-get update
        sudo apt-get install k6
    
    - name: Run Load Test
      run: k6 run --out json=load-results.json performance-tests/load-test.js
      env:
        BASE_URL: http://localhost:5000
      timeout-minutes: 15
    
    - name: Upload Load Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: k6-load-test-results
        path: load-results.json
        retention-days: 30

  # k6ÂéãÂäõÊµãËØï
  k6-stress-test:
    runs-on: ubuntu-latest
    needs: start-server
    if: |
      (github.event.inputs.test_type == 'k6-stress' || 
       github.event.inputs.test_type == 'all' ||
       github.event_name == 'schedule') &&
      needs.start-server.outputs.server-ready == 'true'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET and Start Server
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Build and Start Server
      run: |
        dotnet build --configuration Release
        cd ZakYip.WheelDiverterSorter.Host
        nohup dotnet run --configuration Release --no-build &
        sleep 15
    
    - name: Install k6
      run: |
        sudo gpg -k
        sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
        echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
        sudo apt-get update
        sudo apt-get install k6
    
    - name: Run Stress Test
      run: k6 run --out json=stress-results.json performance-tests/stress-test.js
      env:
        BASE_URL: http://localhost:5000
      timeout-minutes: 20
      continue-on-error: true  # ÂéãÂäõÊµãËØïÂèØËÉΩ‰ºöÂ§±Ë¥•
    
    - name: Upload Stress Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: k6-stress-test-results
        path: stress-results.json
        retention-days: 30

  # k6È´òË¥üËΩΩÊµãËØï (500-1000ÂåÖË£π/ÂàÜÈíü)
  k6-high-load-test:
    runs-on: ubuntu-latest
    needs: start-server
    if: |
      (github.event.inputs.test_type == 'k6-high-load' || 
       github.event.inputs.test_type == 'all' ||
       github.event_name == 'schedule') &&
      needs.start-server.outputs.server-ready == 'true'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET and Start Server
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Build and Start Server
      run: |
        dotnet build --configuration Release
        cd ZakYip.WheelDiverterSorter.Host
        nohup dotnet run --configuration Release --no-build &
        sleep 15
    
    - name: Install k6
      run: |
        sudo gpg -k
        sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
        echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
        sudo apt-get update
        sudo apt-get install k6
    
    - name: Run High-Load Test
      run: k6 run --out json=high-load-results.json performance-tests/high-load-test.js
      env:
        BASE_URL: http://localhost:5000
      timeout-minutes: 60
    
    - name: Analyze High-Load Results
      if: always()
      run: |
        echo "üìä High-Load Test Completed"
        echo "Test scenarios executed:"
        echo "  ‚úÖ 500 parcels/minute (5 minutes)"
        echo "  ‚úÖ 1000 parcels/minute (5 minutes)"
        echo "  ‚úÖ Ramping stress test (500-2000 parcels/minute)"
        echo "  ‚úÖ Stability test (600 parcels/minute for 30 minutes)"
        echo ""
        echo "Check artifacts for detailed results and metrics."
    
    - name: Upload High-Load Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: k6-high-load-test-results
        path: high-load-results.json
        retention-days: 90

  # ÊÄßËÉΩÊµãËØïÊÄªÁªì
  performance-summary:
    runs-on: ubuntu-latest
    needs: [benchmark-tests, high-load-benchmarks, k6-smoke-test, k6-load-test, k6-stress-test, k6-high-load-test]
    if: always() && (github.event.inputs.test_type == 'all' || github.event_name == 'schedule')
    
    steps:
    - name: Performance Test Summary
      run: |
        echo "# üéØ Performance Testing Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Test Type | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| BenchmarkDotNet Tests | ${{ needs.benchmark-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| High-Load Benchmarks | ${{ needs.high-load-benchmarks.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| k6 Smoke Test | ${{ needs.k6-smoke-test.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| k6 Load Test | ${{ needs.k6-load-test.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| k6 Stress Test | ${{ needs.k6-stress-test.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| k6 High-Load Test | ${{ needs.k6-high-load-test.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Performance Targets" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- üéØ Throughput: 500-1000 parcels/minute" >> $GITHUB_STEP_SUMMARY
        echo "- ‚è±Ô∏è P95 Latency: < 500ms" >> $GITHUB_STEP_SUMMARY
        echo "- üé≤ Error Rate: < 5%" >> $GITHUB_STEP_SUMMARY
        echo "- üíæ Memory: Minimal GC pressure" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "üìÅ Download artifacts for detailed analysis" >> $GITHUB_STEP_SUMMARY
